<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" content="#000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CineFrame">
<link rel="manifest" href="./manifest.json">
<link rel="apple-touch-icon" href="./icon-192.png">
<title>CineFrame Pro v4</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=JetBrains+Mono:wght@300;400;700&family=Noto+Kufi+Arabic:wght@400;700&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CINEFRAME PRO v4 â€” COMPLETE DESIGN SYSTEM
   Aesthetic: Precision Cinema Instrument
   Every pixel intentional.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root{
  --bg:#000;--s1:#0a0a0a;--s2:#111;--s3:#181818;
  --b1:#1e1e1e;--b2:#2a2a2a;--b3:#333;
  --acc:#ff3d00;--acc2:#ffab00;--gold:#c9a84c;
  --wh:#ede9e2;--mu1:#666;--mu2:#444;--mu3:#2a2a2a;
  --grn:#00e676;--red:#ff1744;--blu:#2979ff;--cyn:#00e5ff;--pur:#d500f9;
  --mono:'JetBrains Mono',monospace;
  --disp:'Bebas Neue',sans-serif;
  --arab:'Noto Kufi Arabic',sans-serif;
  --r-sm:4px;--r-md:8px;--r-lg:14px;--r-xl:20px;--r-full:999px;
  --sh1:0 2px 8px rgba(0,0,0,.6);
  --sh2:0 4px 20px rgba(0,0,0,.8);
  --sh3:0 8px 40px rgba(0,0,0,.9);
  --tr:.15s ease;--tr-slow:.35s cubic-bezier(.16,1,.3,1);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}
html,body{width:100%;height:100%;background:var(--bg);color:var(--wh);font-family:var(--mono);overflow:hidden;user-select:none;-webkit-font-smoothing:antialiased}

/* â•â• SPLASH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#splash{
  position:fixed;inset:0;z-index:9999;
  background:#000;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:10px;
  transition:opacity .6s ease;
}
#splash.out{opacity:0;pointer-events:none}
.sp-bg{
  position:absolute;inset:0;
  background:radial-gradient(ellipse at 50% 60%, rgba(255,61,0,.08) 0%, transparent 65%);
}
.sp-logo{
  font-family:var(--disp);font-size:clamp(52px,14vw,90px);
  letter-spacing:10px;line-height:1;position:relative;z-index:1;
  animation:spUp .9s cubic-bezier(.16,1,.3,1) .2s both;
}
.sp-logo em{color:var(--acc);font-style:normal}
.sp-ver{
  font-size:9px;letter-spacing:6px;color:var(--mu1);text-transform:uppercase;
  animation:spUp .9s .35s both;position:relative;z-index:1;
}
.sp-line{
  width:160px;height:1px;background:var(--b1);overflow:hidden;
  margin-top:10px;position:relative;z-index:1;animation:spUp 0s .5s both;
}
.sp-line::after{
  content:'';position:absolute;top:0;left:-100%;height:100%;width:100%;
  background:linear-gradient(90deg,transparent,var(--acc),transparent);
  animation:spSlide 1.8s ease .6s forwards;
}
@keyframes spUp{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:none}}
@keyframes spSlide{to{left:100%}}

/* â•â• LOCK SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#lock-screen{
  position:fixed;inset:0;z-index:8000;
  background:linear-gradient(160deg,#0a0a0a 0%,#111 40%,#0d0d0d 100%);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:0;padding:40px 20px;transition:opacity .4s,transform .4s;
}
#lock-screen.locked-out{animation:shake .5s ease}
@keyframes shake{0%,100%{transform:none}20%,60%{transform:translateX(-10px)}40%,80%{transform:translateX(10px)}}
.lock-icon{font-size:40px;margin-bottom:20px;opacity:.6}
.lock-title{font-family:var(--disp);font-size:30px;letter-spacing:5px;margin-bottom:6px}
.lock-sub{font-size:9px;letter-spacing:2px;color:var(--mu1);margin-bottom:32px}
.pin-dots{display:flex;gap:14px;margin-bottom:30px}
.pd{
  width:16px;height:16px;border-radius:50%;
  border:2px solid var(--b3);background:transparent;
  transition:all .2s;
}
.pd.filled{background:var(--acc);border-color:var(--acc);box-shadow:0 0 10px rgba(255,61,0,.5)}
.pin-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;width:240px}
.pk{
  height:60px;border-radius:var(--r-md);border:1px solid var(--b2);
  background:var(--s2);font-family:var(--disp);font-size:24px;
  letter-spacing:2px;color:var(--wh);cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all .12s;user-select:none;
}
.pk:active,.pk.pressed{transform:scale(.92);background:var(--b1);border-color:var(--acc)}
.pk.del{font-size:18px;color:var(--mu1)}
.pk.del:active{color:var(--red)}
.lock-err{
  font-size:10px;letter-spacing:1px;color:var(--red);
  margin-top:12px;height:16px;transition:opacity .3s;
}

/* â•â• APP SHELL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app{
  width:100%;height:100%;display:flex;flex-direction:column;
  opacity:0;transition:opacity .5s;pointer-events:none;
}
#app.alive{opacity:1;pointer-events:all}

/* â•â• TOPBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#topbar{
  background:var(--s1);border-bottom:1px solid var(--b1);
  height:46px;flex-shrink:0;
  display:flex;align-items:center;padding:0 10px;gap:6px;
  position:relative;z-index:50;
}
.brand{font-family:var(--disp);font-size:20px;letter-spacing:4px;flex:1}
.brand em{color:var(--acc);font-style:normal}
.tbs{display:flex;gap:5px}
.tb{
  width:32px;height:32px;border-radius:var(--r-sm);
  border:1px solid var(--b2);background:var(--s2);
  color:var(--wh);display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:13px;transition:var(--tr);flex-shrink:0;
}
.tb:active{transform:scale(.86)}
.tb.on{border-color:var(--acc);color:var(--acc);background:rgba(255,61,0,.08)}
.tb.locked{opacity:.4;pointer-events:none;position:relative}
.tb.locked::after{content:'ğŸ”’';position:absolute;font-size:7px;top:-3px;right:-3px}

/* â•â• MODEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#modebar{
  background:var(--s1);border-bottom:1px solid var(--b1);
  height:36px;flex-shrink:0;display:flex;overflow-x:auto;
  scrollbar-width:none;padding:0 4px;
}
#modebar::-webkit-scrollbar{display:none}
.md{
  flex-shrink:0;height:36px;padding:0 13px;
  font-size:8.5px;letter-spacing:2px;text-transform:uppercase;
  color:var(--mu1);cursor:pointer;display:flex;align-items:center;
  border-bottom:2px solid transparent;transition:var(--tr);white-space:nowrap;
}
.md.on{color:var(--acc);border-bottom-color:var(--acc)}
.md.locked{opacity:.35;pointer-events:none}
.md.locked::after{content:' ğŸ”’';font-size:8px}

/* â•â• VIEWFINDER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#vf{
  position:relative;flex:1;overflow:hidden;
  background:#000;
}

/* Black screen fallback - shows when no camera */
#no-cam-bg{
  position:absolute;inset:0;background:#000;z-index:1;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:10px;opacity:0;pointer-events:none;transition:opacity .4s;
}
#no-cam-bg.show{opacity:1}
.ncb-pulse{
  width:80px;height:80px;border-radius:50%;
  border:1px solid rgba(255,61,0,.3);
  display:flex;align-items:center;justify-content:center;
  font-size:30px;animation:camPulse 2s ease infinite;
}
@keyframes camPulse{50%{border-color:rgba(255,61,0,.8);box-shadow:0 0 20px rgba(255,61,0,.2)}}
.ncb-txt{font-size:10px;letter-spacing:2px;color:var(--mu1)}
.ncb-sub{font-size:8px;letter-spacing:1px;color:var(--mu2)}

#video{
  position:absolute;inset:0;width:100%;height:100%;
  object-fit:cover;display:block;
  transform-origin:center;transition:filter .15s;z-index:2;
}

/* Cinema bars */
.cbar{position:absolute;left:0;right:0;background:#000;z-index:10;transition:height .45s cubic-bezier(.4,0,.2,1)}
#cb-t{top:0;height:0}
#cb-b{bottom:0;height:0}
.cbar.on{height:12.5%}

/* Grid canvas */
#grid-cvs{
  position:absolute;inset:0;width:100%;height:100%;
  pointer-events:none;z-index:11;opacity:0;transition:opacity .3s;
}
#grid-cvs.on{opacity:1}

/* Focus ring */
#fring{
  position:absolute;width:64px;height:64px;
  pointer-events:none;z-index:18;opacity:0;
  transform:translate(-50%,-50%) scale(1.5);transition:all .2s;
}
#fring.show{opacity:1;transform:translate(-50%,-50%) scale(1)}
#fring.lock svg rect{stroke:var(--grn)}
#fring.lock svg line,#fring.lock svg circle{stroke:var(--grn);fill:var(--grn)}
#fring.lock{animation:fpuls 1.5s ease infinite}
@keyframes fpuls{50%{opacity:.35}}

/* Zoom HUD */
#zh{
  position:absolute;bottom:12px;left:50%;
  transform:translateX(-50%) translateY(4px);
  background:rgba(0,0,0,.75);backdrop-filter:blur(12px);
  border:1px solid rgba(255,255,255,.1);border-radius:var(--r-full);
  padding:4px 14px;font-size:11px;letter-spacing:1px;
  z-index:22;opacity:0;transition:all .25s;pointer-events:none;
}
#zh.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* Processing overlay */
#proc{
  position:absolute;inset:0;z-index:60;
  background:rgba(0,0,0,.78);backdrop-filter:blur(6px);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:12px;opacity:0;pointer-events:none;transition:opacity .25s;
}
#proc.on{opacity:1;pointer-events:all}
.proc-lbl{font-size:9px;letter-spacing:3px;color:var(--mu1);text-transform:uppercase}
.proc-bar{width:210px;height:2px;background:var(--b1);border-radius:1px;overflow:hidden}
.proc-fill{height:100%;background:var(--acc);border-radius:1px;width:0%;transition:width .2s}
.proc-step{font-size:8px;letter-spacing:1px;color:var(--acc2);min-height:12px}

/* â•â• HUD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#hud{
  position:absolute;inset:0;z-index:20;
  pointer-events:none;padding:10px;
  display:flex;flex-direction:column;justify-content:space-between;
}
.hr{display:flex;justify-content:space-between;align-items:flex-start}
.hb{display:flex;justify-content:space-between;align-items:flex-end}
.chip{
  display:block;
  background:rgba(0,0,0,.68);backdrop-filter:blur(8px);
  border:1px solid rgba(255,255,255,.07);border-radius:3px;
  padding:3px 7px;font-size:8px;letter-spacing:.7px;line-height:1.7;
  color:var(--wh);margin-bottom:3px;
}
.chip.acc{border-color:rgba(255,61,0,.35);color:var(--acc)}
.chip.amb{border-color:rgba(255,171,0,.25);color:var(--acc2)}
.chip.grn{border-color:rgba(0,230,118,.2);color:var(--grn)}
.chip.red{border-color:rgba(255,23,68,.25);color:var(--red)}
.chip.blu{border-color:rgba(41,121,255,.25);color:var(--blu)}
.chip.pur{border-color:rgba(213,0,249,.25);color:var(--pur)}
#rec-dot{display:inline-block;width:5px;height:5px;border-radius:50%;
  background:var(--red);margin-left:4px;vertical-align:middle;
  box-shadow:0 0 5px var(--red);animation:recb 1s ease infinite}
@keyframes recb{50%{opacity:.1}}
#hist-c{width:86px;height:34px;display:block}
#wave-c{width:56px;height:26px;display:block}

/* â•â• BOTTOM PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#btm{
  background:var(--s1);border-top:1px solid var(--b1);
  padding:8px 10px 18px;flex-shrink:0;
}

/* LUT/Filter Strip */
#lut-strip{
  display:flex;gap:7px;overflow-x:auto;
  scrollbar-width:none;padding-bottom:8px;margin-bottom:9px;
}
#lut-strip::-webkit-scrollbar{display:none}
.lfi{flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;transition:var(--tr)}
.lfi:active{transform:scale(.9)}
.lfi-sw{
  width:48px;height:48px;border-radius:var(--r-md);
  border:2px solid var(--b2);overflow:hidden;
  transition:border-color .18s;position:relative;
}
.lfi.on .lfi-sw{border-color:var(--acc);box-shadow:0 0 8px rgba(255,61,0,.3)}
.lfi-nm{font-size:6.5px;letter-spacing:.4px;color:var(--mu1);text-transform:uppercase}
.lfi.on .lfi-nm{color:var(--acc)}
.lfi-sw canvas{width:100%;height:100%;display:block}

/* Sliders */
.slgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:11px}
.sg{display:flex;flex-direction:column;gap:3px}
.sgl{font-size:7.5px;letter-spacing:.8px;color:var(--mu1);
  text-transform:uppercase;display:flex;justify-content:space-between}
.sgl b{color:var(--wh);font-weight:700;font-size:8px}
input[type=range]{
  -webkit-appearance:none;width:100%;height:2px;border-radius:1px;
  background:var(--b2);outline:none;cursor:pointer;
}
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;width:12px;height:12px;border-radius:50%;
  background:var(--acc);border:2px solid var(--s1);
  box-shadow:0 0 4px rgba(255,61,0,.4);transition:transform .1s;
}
input[type=range]::-webkit-slider-thumb:active{transform:scale(1.35)}
.iso-r::-webkit-slider-thumb{background:var(--acc2)!important}
.wb-r::-webkit-slider-thumb{background:var(--blu)!important}
.ss-r::-webkit-slider-thumb{background:var(--cyn)!important}

/* Shutter Row */
.shr{display:flex;align-items:center;justify-content:space-between;gap:6px}
.ctrls{display:flex;gap:6px;align-items:center}
.cb{
  width:42px;height:42px;border-radius:var(--r-md);
  border:1px solid var(--b2);background:var(--s2);
  color:var(--wh);display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:16px;transition:var(--tr);flex-shrink:0;
}
.cb:active{transform:scale(.88);background:var(--b1)}
.cb.on{border-color:var(--acc);color:var(--acc)}
.cb.locked{opacity:.3;pointer-events:none;position:relative}
.cb.locked::after{content:'ğŸ”’';position:absolute;font-size:7px;top:-3px;right:-3px}

/* Shutter Button */
#shutter{
  width:72px;height:72px;border-radius:50%;
  background:var(--wh);flex-shrink:0;
  border:4px solid rgba(255,255,255,.1);
  box-shadow:0 0 0 2px var(--b2),0 4px 20px rgba(0,0,0,.7);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:transform .1s,box-shadow .1s;
}
#shutter:active{transform:scale(.9)}
#shutter.rec{background:var(--red);animation:recRing 2s ease infinite}
@keyframes recRing{50%{box-shadow:0 0 0 10px rgba(255,23,68,.1),0 4px 20px rgba(0,0,0,.7)}}
#sh-in{width:22px;height:22px;border-radius:4px;background:#000;transition:all .18s}
#shutter.rec #sh-in{border-radius:3px;background:#fff}

/* Zoom Pill */
.zpill{
  background:var(--s2);border:1px solid var(--b2);
  border-radius:var(--r-xl);padding:4px 3px;
  display:flex;flex-direction:column;gap:1px;
}
.zo{
  font-size:8.5px;font-weight:700;font-family:var(--mono);
  color:var(--mu1);padding:3px 7px;border-radius:14px;
  cursor:pointer;transition:var(--tr);text-align:center;
}
.zo.on{background:var(--acc);color:#fff}

/* â•â• PANELS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.panel{
  position:absolute;inset:0;background:var(--bg);z-index:100;
  overflow-y:auto;padding:18px;
  transition:transform var(--tr-slow);
}
#settings-p{transform:translateX(100%)}
#settings-p.open{transform:none}
#gallery-p{transform:translateY(100%)}
#gallery-p.open{transform:none}
#editor-p{transform:translateX(-100%)}
#editor-p.open{transform:none}
.ph{
  font-family:var(--disp);font-size:22px;letter-spacing:4px;
  margin-bottom:18px;display:flex;align-items:center;justify-content:space-between;
}
.pcl{
  width:30px;height:30px;border-radius:50%;
  background:var(--s2);border:1px solid var(--b2);
  color:var(--wh);display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:13px;flex-shrink:0;
}
.pcl:active{transform:scale(.9)}
.sec-lbl{
  font-size:7.5px;letter-spacing:3px;color:var(--acc);text-transform:uppercase;
  margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid var(--b1);
  margin-top:18px;
}
.srow{
  display:flex;justify-content:space-between;align-items:center;
  padding:9px 0;border-bottom:1px solid rgba(255,255,255,.03);gap:8px;
}
.slbl{font-size:10px;color:var(--wh)}
.sdsc{font-size:8px;color:var(--mu1);margin-top:1px}
.tog{
  width:38px;height:20px;background:var(--b2);
  border-radius:10px;position:relative;cursor:pointer;
  transition:background .2s;flex-shrink:0;
}
.tog.on{background:var(--acc)}
.tog::after{content:'';position:absolute;width:14px;height:14px;
  background:#fff;border-radius:50%;top:3px;left:3px;transition:transform .2s}
.tog.on::after{transform:translateX(18px)}
.tog.locked{opacity:.3;pointer-events:none}
.sel{
  background:var(--s2);border:1px solid var(--b2);color:var(--wh);
  border-radius:var(--r-sm);padding:4px 7px;font-family:var(--mono);
  font-size:9px;outline:none;cursor:pointer;
}

/* Gallery */
#gal-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:2px}
.gi{
  aspect-ratio:1;background:var(--s2);overflow:hidden;
  position:relative;cursor:pointer;border-radius:2px;
}
.gi img{width:100%;height:100%;object-fit:cover;display:block}
.gi-m{
  position:absolute;bottom:0;left:0;right:0;padding:4px;
  background:linear-gradient(transparent,rgba(0,0,0,.85));font-size:6.5px;
  color:rgba(255,255,255,.55);
}
.gi-del{
  position:absolute;top:3px;right:3px;width:18px;height:18px;
  background:rgba(255,23,68,.8);border-radius:50%;
  display:flex;align-items:center;justify-content:center;font-size:9px;
  opacity:0;transition:opacity .15s;
}
.gi:hover .gi-del,.gi:focus .gi-del{opacity:1}
.gempty{grid-column:1/-1;text-align:center;padding:50px;color:var(--mu2);font-size:10px;letter-spacing:1px}
.gempty .ei{font-size:40px;margin-bottom:10px;opacity:.2}

/* Editor */
.ed-prev{
  width:100%;aspect-ratio:16/9;background:#000;border-radius:var(--r-md);
  overflow:hidden;margin-bottom:14px;border:1px solid var(--b1);position:relative;
}
.ed-prev img{width:100%;height:100%;object-fit:contain;display:block}
.algo-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:14px}
.abtn{
  padding:9px;border-radius:var(--r-sm);border:1px solid var(--b2);
  background:var(--s2);cursor:pointer;transition:var(--tr);
}
.abtn:active{transform:scale(.95)}
.abtn.on{border-color:var(--acc);background:rgba(255,61,0,.06)}
.abtn-n{font-size:8.5px;letter-spacing:.5px;color:var(--wh)}
.abtn-d{font-size:7px;color:var(--mu1);margin-top:1px}
.ed-btn{
  width:100%;padding:13px;background:var(--acc);color:#fff;
  border:none;border-radius:var(--r-md);font-family:var(--mono);font-size:10px;
  letter-spacing:2px;cursor:pointer;text-transform:uppercase;margin-bottom:8px;
}
.ed-dl{
  width:100%;padding:10px;background:transparent;color:var(--mu1);
  border:1px solid var(--b2);border-radius:var(--r-md);font-family:var(--mono);
  font-size:10px;letter-spacing:1px;cursor:pointer;
}

/* â•â• OVERLAYS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#flash-o{position:fixed;inset:0;background:#fff;z-index:400;opacity:0;pointer-events:none}
#flash-o.go{animation:fl .25s ease}
@keyframes fl{0%{opacity:.95}100%{opacity:0}}

#cd-o{
  position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.5);
  display:none;align-items:center;justify-content:center;
}
#cd-o.show{display:flex}
#cd-n{
  font-family:var(--disp);font-size:150px;
  color:#fff;text-shadow:0 0 50px var(--acc);
  animation:cdp .9s ease infinite;
}
@keyframes cdp{50%{opacity:.15}}

#toast-el{
  position:fixed;bottom:130px;left:50%;
  transform:translateX(-50%) translateY(10px);
  background:rgba(0,0,0,.9);backdrop-filter:blur(14px);
  border:1px solid var(--b2);border-radius:var(--r-full);
  padding:6px 16px;font-size:9px;letter-spacing:.7px;color:var(--wh);
  z-index:500;opacity:0;pointer-events:none;transition:all .2s;
  max-width:80vw;text-align:center;
}
#toast-el.show{opacity:1;transform:translateX(-50%) translateY(0)}

#install-bar{
  position:fixed;bottom:0;left:0;right:0;z-index:700;
  background:var(--s1);border-top:1px solid var(--b1);
  padding:10px 14px;display:none;align-items:center;justify-content:space-between;gap:8px;
}
#install-bar.show{display:flex}
.inst-t{font-size:9px;color:var(--wh)}
.inst-t small{display:block;color:var(--mu1);font-size:7px;margin-top:1px}
.inst-btn{
  padding:7px 13px;background:var(--acc);color:#fff;border:none;
  border-radius:var(--r-sm);font-family:var(--mono);font-size:9px;cursor:pointer;
}

/* grain */
body::after{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:600;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.04'/%3E%3C/svg%3E");
  opacity:.28;
}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="sp-bg"></div>
  <div class="sp-logo">CINE<em>FRAME</em></div>
  <div class="sp-ver">Pro v4 Â· 40+ Algorithms Â· Cinema Grade</div>
  <div class="sp-line"></div>
</div>

<!-- LOCK SCREEN -->
<div id="lock-screen">
  <div class="lock-icon">ğŸ¬</div>
  <div class="lock-title">CINEFRAME</div>
  <div class="lock-sub">Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
  <div class="pin-dots" id="pin-dots">
    <div class="pd" id="pd0"></div>
    <div class="pd" id="pd1"></div>
    <div class="pd" id="pd2"></div>
    <div class="pd" id="pd3"></div>
  </div>
  <div class="pin-grid" id="pin-grid">
    <div class="pk" data-n="1">1</div><div class="pk" data-n="2">2</div><div class="pk" data-n="3">3</div>
    <div class="pk" data-n="4">4</div><div class="pk" data-n="5">5</div><div class="pk" data-n="6">6</div>
    <div class="pk" data-n="7">7</div><div class="pk" data-n="8">8</div><div class="pk" data-n="9">9</div>
    <div class="pk" data-n="skip" style="font-size:8px;letter-spacing:1px;color:var(--mu1)">SKIP</div>
    <div class="pk" data-n="0">0</div>
    <div class="pk del" data-n="del">âŒ«</div>
  </div>
  <div class="lock-err" id="lock-err"></div>
</div>

<!-- OVERLAYS -->
<div id="flash-o"></div>
<div id="cd-o"><div id="cd-n">3</div></div>
<div id="toast-el"></div>
<div id="install-bar">
  <div class="inst-t">Ø«Ø¨Ù‘Øª CineFrame Pro<small>Ø£Ø¶ÙÙ‡ Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</small></div>
  <button class="inst-btn" id="do-install">ØªØ«Ø¨ÙŠØª â¬‡</button>
</div>

<!-- APP -->
<div id="app">

  <!-- TOPBAR -->
  <div id="topbar">
    <div class="brand">CINE<em>FRAME</em></div>
    <div class="tbs">
      <div class="tb" id="btn-grid">âŠ</div>
      <div class="tb" id="btn-hist">ğŸ“Š</div>
      <div class="tb" id="btn-editor">âœ</div>
      <div class="tb" id="btn-flip">ğŸ”„</div>
      <div class="tb" id="btn-lock-feat" title="Ù‚ÙÙ„/ÙØªØ­ Ø§Ù„Ù…ÙŠØ²Ø§Øª">ğŸ”’</div>
      <div class="tb" id="btn-settings">âš™</div>
    </div>
  </div>

  <!-- MODEBAR -->
  <div id="modebar">
    <div class="md on" data-mode="photo">PHOTO</div>
    <div class="md" data-mode="video">VIDEO</div>
    <div class="md" data-mode="cine">CINE 4K</div>
    <div class="md" data-mode="slow">SLOW-MO</div>
    <div class="md" data-mode="portrait">PORTRAIT</div>
    <div class="md" data-mode="night">NIGHT</div>
    <div class="md" data-mode="pro">PRO</div>
    <div class="md" data-mode="astro">ASTRO</div>
  </div>

  <!-- VIEWFINDER -->
  <div id="vf">
    <!-- Black screen when camera unavailable -->
    <div id="no-cam-bg">
      <div class="ncb-pulse">ğŸ“·</div>
      <div class="ncb-txt">Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ù…ØªØ§Ø­Ø©</div>
      <div class="ncb-sub">Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„ â€” Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ØªØµÙˆÙŠØ±</div>
    </div>

    <video id="video" autoplay muted playsinline></video>
    <canvas id="grid-cvs"></canvas>

    <div class="cbar" id="cb-t"></div>
    <div class="cbar" id="cb-b"></div>

    <!-- Focus ring -->
    <div id="fring">
      <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="1" y="1" width="62" height="62" rx="2" stroke="#ffab00" stroke-width="1.5"/>
        <line x1="32" y1="0" x2="32" y2="12" stroke="#ffab00" stroke-width="1"/>
        <line x1="32" y1="52" x2="32" y2="64" stroke="#ffab00" stroke-width="1"/>
        <line x1="0" y1="32" x2="12" y2="32" stroke="#ffab00" stroke-width="1"/>
        <line x1="52" y1="32" x2="64" y2="32" stroke="#ffab00" stroke-width="1"/>
        <circle cx="32" cy="32" r="2.5" fill="#ffab00"/>
      </svg>
    </div>

    <div id="zh">1.0Ã—</div>

    <!-- Processing overlay -->
    <div id="proc">
      <div class="proc-lbl">Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©</div>
      <div class="proc-bar"><div class="proc-fill" id="pf"></div></div>
      <div class="proc-step" id="ps">Ø¬Ø§Ø±Ù Ø§Ù„ØªÙ‡ÙŠØ¦Ø©â€¦</div>
    </div>

    <!-- HUD -->
    <div id="hud">
      <div class="hr">
        <div>
          <span class="chip" id="h-mode">PHOTO</span>
          <span class="chip" id="h-res">â€”</span>
          <span class="chip acc" id="h-lut">Normal</span>
        </div>
        <div style="text-align:right">
          <canvas id="hist-c"></canvas>
          <span class="chip amb" id="h-iso" style="margin-top:4px">ISO 100</span>
          <span class="chip" id="h-ss">1/60s</span>
          <span class="chip" id="h-fps">30 FPS</span>
        </div>
      </div>
      <div class="hb">
        <div>
          <span class="chip blu" id="h-wb">5600K</span>
          <span class="chip grn" id="h-zoom">1.0Ã—</span>
          <span class="chip" id="h-face">Face: â€”</span>
        </div>
        <div style="text-align:right">
          <canvas id="wave-c"></canvas>
          <span class="chip" id="h-shots">0 SHOTS</span>
          <span class="chip pur" id="h-algo">Pipeline: iPhone ISP</span>
        </div>
      </div>
    </div>
  </div>

  <!-- BOTTOM -->
  <div id="btm">
    <div id="lut-strip"></div>
    <div class="slgrid">
      <div class="sg">
        <div class="sgl">EV<b id="ev-v">Â±0</b></div>
        <input type="range" id="sl-ev" min="-3" max="3" step="0.1" value="0">
      </div>
      <div class="sg">
        <div class="sgl">ISO<b id="iso-v">100</b></div>
        <input type="range" class="iso-r" id="sl-iso" min="0" max="7" step="1" value="0">
      </div>
      <div class="sg">
        <div class="sgl">WB<b id="wb-v">5600</b></div>
        <input type="range" class="wb-r" id="sl-wb" min="2000" max="10000" step="100" value="5600">
      </div>
      <div class="sg">
        <div class="sgl">SHARP<b id="sh-v">0</b></div>
        <input type="range" id="sl-sh" min="-2" max="2" step="0.1" value="0">
      </div>
    </div>
    <div class="shr">
      <div class="ctrls">
        <div class="cb" id="btn-flash">âš¡</div>
        <div class="cb" id="btn-timer">â±</div>
        <div class="cb" id="btn-pip">â–¶</div>
      </div>
      <div id="shutter"><div id="sh-in"></div></div>
      <div class="ctrls">
        <div class="zpill">
          <div class="zo on" data-z="1">1Ã—</div>
          <div class="zo" data-z="2">2Ã—</div>
          <div class="zo" data-z="5">5Ã—</div>
          <div class="zo" data-z="10">10Ã—</div>
        </div>
        <div class="cb" id="btn-gallery">ğŸ–¼</div>
      </div>
    </div>
  </div>

  <!-- SETTINGS PANEL -->
  <div class="panel" id="settings-p">
    <div class="ph">SETTINGS<div class="pcl" id="cls-s">âœ•</div></div>
    <div class="sec-lbl">ğŸ”’ Ø§Ù„Ø­Ù…Ø§ÙŠØ© ÙˆÙ‚ÙÙ„ Ø§Ù„Ù…ÙŠØ²Ø§Øª</div>
    <div class="srow">
      <div><div class="slbl">PIN Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­</div><div class="sdsc">Ø±Ù…Ø² 4 Ø£Ø±Ù‚Ø§Ù… Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</div></div>
      <div class="tog" id="tog-pin" data-k="pinOnOpen"></div>
    </div>
    <div class="srow">
      <div><div class="slbl">ØªØºÙŠÙŠØ± Ø§Ù„Ù€ PIN</div></div>
      <button style="padding:5px 12px;background:var(--s2);border:1px solid var(--b2);color:var(--wh);border-radius:4px;font-family:var(--mono);font-size:9px;cursor:pointer" id="btn-change-pin">ØªØºÙŠÙŠØ± â†’</button>
    </div>
    <div class="srow">
      <div><div class="slbl">Ù‚ÙÙ„ ÙˆØ¶Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</div><div class="sdsc">ÙŠØ­Ø¬Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div></div>
      <div class="tog" data-k="lockVideo" id="tog-lv"></div>
    </div>
    <div class="srow">
      <div><div class="slbl">Ù‚ÙÙ„ Ø§Ù„Ù…Ø­Ø±Ø±</div><div class="sdsc">ÙŠØ­Ø¬Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ±</div></div>
      <div class="tog" data-k="lockEditor" id="tog-le"></div>
    </div>
    <div class="srow">
      <div><div class="slbl">Ù‚ÙÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</div></div>
      <div class="tog" data-k="lockPro" id="tog-lp"></div>
    </div>
    <div class="sec-lbl">ğŸ¬ Ø³ÙŠÙ†Ù…Ø§</div>
    <div class="srow"><div><div class="slbl">Ø£Ø´Ø±Ø·Ø© Ø³ÙŠÙ†Ù…Ø§Ø¦ÙŠØ©</div><div class="sdsc">2.39:1</div></div><div class="tog" data-k="cinebars"></div></div>
    <div class="srow"><div><div class="slbl">Focus Peaking</div></div><div class="tog on" data-k="peaking"></div></div>
    <div class="srow"><div><div class="slbl">Zebra Stripes</div><div class="sdsc">ØªØ­Ø°ÙŠØ± Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø© Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©</div></div><div class="tog" data-k="zebra"></div></div>
    <div class="srow"><div><div class="slbl">ØªØ·Ø¨ÙŠÙ‚ Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</div><div class="sdsc">Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·</div></div><div class="tog on" data-k="autoPipeline"></div></div>
    <div class="sec-lbl">ğŸ“¹ ÙÙŠØ¯ÙŠÙˆ</div>
    <div class="srow"><div><div class="slbl">4K Recording</div></div><div class="tog on" data-k="4k"></div></div>
    <div class="srow"><div><div class="slbl">60 FPS</div></div><div class="tog" data-k="60fps"></div></div>
    <div class="srow"><div><div class="slbl">Log Profile</div></div><div class="tog" data-k="log"></div></div>
    <div class="srow"><div><div class="slbl">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø±Ø¶</div></div><select class="sel" id="asp-sel"><option>16:9</option><option>4:3</option><option>1:1</option><option>2.39:1</option></select></div>
    <div class="sec-lbl">âš™ Ù†Ø¸Ø§Ù…</div>
    <div class="srow"><div><div class="slbl">Histogram Ø­ÙŠ</div></div><div class="tog on" data-k="histogram"></div></div>
    <div class="srow"><div><div class="slbl">Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø²</div></div><div class="tog on" data-k="haptic"></div></div>
    <div class="srow"><div><div class="slbl">Ù†ÙˆØ¹ Ø§Ù„Ø´Ø¨ÙƒØ©</div></div><select class="sel" id="grid-type"><option>Rule of Thirds</option><option>Phi Grid</option><option>Square</option><option>Diagonal</option></select></div>
  </div>

  <!-- GALLERY PANEL -->
  <div class="panel" id="gallery-p">
    <div class="ph">GALLERY<div class="pcl" id="cls-g">âœ•</div></div>
    <div id="gal-grid"><div class="gempty"><div class="ei">ğŸ“·</div>Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ø¨Ø¹Ø¯</div></div>
  </div>

  <!-- EDITOR PANEL -->
  <div class="panel" id="editor-p">
    <div class="ph">EDITOR<div class="pcl" id="cls-e">âœ•</div></div>
    <div class="ed-prev"><img id="ed-img" src="" alt=""></div>
    <div class="sec-lbl" style="margin-top:0">ğŸ§  Ø§Ø®ØªØ± Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª</div>
    <div class="algo-grid" id="algo-grid"></div>
    <button class="ed-btn" id="ed-apply">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª â†’</button>
    <button class="ed-dl" id="ed-dl">Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© â¬‡</button>
  </div>

</div><!-- #app -->

<canvas id="cap-cvs" style="display:none"></canvas>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CINEFRAME PRO v4 â€” COMPLETE APPLICATION ENGINE
   Features: 40+ Algorithms, Lock System, Black Screen Fallback,
   Nokia-to-iPhone Enhancement, LUTs, PWA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
'use strict';

// â•â• CONFIG & CONSTANTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ISO_STEPS=[100,200,400,800,1600,3200,6400,12800];
const DEFAULT_PIN='1234';
const LOCKED_MODES=['video','cine','slow'];

// â•â• STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S={
  mode:'photo', lut:'normal', lutStr:1.0,
  ev:0, iso:100, wb:5600, zoom:1, sharp:0,
  flash:'off', timer:0,
  photos:[], camReady:false,
  recording:false, recStart:0, recTicker:null,
  stream:null, recorder:null, chunks:[],
  edPhoto:null, edAlgos:new Set(),
  pin:localStorage.getItem('cf_pin')||DEFAULT_PIN,
  pinEntered:'',
  featureLocks:{
    lockVideo:   JSON.parse(localStorage.getItem('cf_lv')||'false'),
    lockEditor:  JSON.parse(localStorage.getItem('cf_le')||'false'),
    lockPro:     JSON.parse(localStorage.getItem('cf_lp')||'false'),
  },
  featLockActive: false, // Master: are feature locks shown?
  settings:{
    pinOnOpen:    JSON.parse(localStorage.getItem('cf_pin_on')||'false'),
    cinebars:false, peaking:true, zebra:false,
    autoPipeline: true,
    '4k':true,'60fps':false,'log':false,
    histogram:true, haptic:true,
  },
  deferredInstall:null,
};

// â•â• DOM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const $=id=>document.getElementById(id);
const QA=s=>document.querySelectorAll(s);
const video=$('video'), capCvs=$('cap-cvs');
const histCvs=$('hist-c'), histCtx=histCvs.getContext('2d');
const waveCvs=$('wave-c'), waveCtx=waveCvs.getContext('2d');
const gridCvs=$('grid-cvs'), gridCtx=gridCvs.getContext('2d');
const fring=$('fring');
const cbT=$('cb-t'), cbB=$('cb-b');
const shutter=$('shutter');
const flashO=$('flash-o');
const toastEl=$('toast-el');
const procEl=$('proc');
histCvs.width=86; histCvs.height=34;
waveCvs.width=56; waveCvs.height=26;

// â•â• UTILS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg,ms=2200){
  toastEl.textContent=msg;
  toastEl.classList.add('show');
  clearTimeout(toastEl._t);
  toastEl._t=setTimeout(()=>toastEl.classList.remove('show'),ms);
}
function haptic(h='light'){
  if(!S.settings.haptic)return;
  try{navigator.vibrate&&navigator.vibrate(h==='heavy'?35:10);}catch(e){}
}
function fmtMs(ms){const s=Math.floor(ms/1000),m=Math.floor(s/60);return`${String(m).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`}
function wbName(k){return k<3200?'TUNGSTEN':k<4200?'FLUOR':k<5500?'DAYLIGHT':k<6500?'CLOUDY':'SHADE'}
function clamp(v,mn=0,mx=255){return Math.max(mn,Math.min(mx,v))}
function lerp(a,b,t){return a+(b-a)*t}
function showProc(show,step='',pct=0){
  procEl.classList.toggle('on',show);
  if(show){$('pf').style.width=pct+'%';$('ps').textContent=step;}
}
function updateSS(){
  const fps=S.settings['60fps']?60:30;
  $('h-ss').textContent='1/'+Math.max(4,Math.min(8000,Math.round(1/(fps/180*(S.iso/100)))))+'s';
}

// â•â• PIN / LOCK SYSTEM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initLockScreen(){
  const ls=$('lock-screen');

  // If PIN on open is disabled, skip straight to app
  if(!S.settings.pinOnOpen){
    ls.style.display='none';
    return;
  }
  ls.style.display='flex';
}

function setupPinGrid(){
  QA('#pin-grid .pk').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const n=btn.dataset.n;
      if(n==='skip'){ skipLock(); return; }
      if(n==='del'){ S.pinEntered=S.pinEntered.slice(0,-1); }
      else if(S.pinEntered.length<4){ S.pinEntered+=n; }
      updatePinDots();
      haptic();
      btn.classList.add('pressed');
      setTimeout(()=>btn.classList.remove('pressed'),150);
      if(S.pinEntered.length===4) checkPin();
    });
  });
}

function updatePinDots(){
  for(let i=0;i<4;i++){
    $('pd'+i).classList.toggle('filled', i<S.pinEntered.length);
  }
}

function checkPin(){
  if(S.pinEntered===S.pin){
    $('lock-screen').classList.add('out');
    setTimeout(()=>{ $('lock-screen').style.display='none'; },450);
    $('lock-err').textContent='';
  } else {
    $('lock-screen').classList.add('locked-out');
    setTimeout(()=>$('lock-screen').classList.remove('locked-out'),550);
    $('lock-err').textContent='Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­ â€” Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹';
    S.pinEntered='';
    updatePinDots();
    haptic('heavy');
  }
}

function skipLock(){
  $('lock-screen').classList.add('out');
  setTimeout(()=>$('lock-screen').style.display='none',450);
}

// Change PIN flow
$('btn-change-pin').addEventListener('click',()=>{
  const newPin=prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù€ PIN Ø§Ù„Ø¬Ø¯ÙŠØ¯ (4 Ø£Ø±Ù‚Ø§Ù…):');
  if(newPin && /^\d{4}$/.test(newPin)){
    S.pin=newPin;
    localStorage.setItem('cf_pin',newPin);
    toast('âœ… ØªÙ… ØªØºÙŠÙŠØ± PIN Ø¨Ù†Ø¬Ø§Ø­');
  } else if(newPin!==null){
    toast('âŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 4 Ø£Ø±Ù‚Ø§Ù… Ø¨Ø§Ù„Ø¶Ø¨Ø·');
  }
});

// Master feature lock toggle
$('btn-lock-feat').addEventListener('click',()=>{
  S.featLockActive=!S.featLockActive;
  $('btn-lock-feat').textContent=S.featLockActive?'ğŸ”“':'ğŸ”’';
  $('btn-lock-feat').classList.toggle('on',S.featLockActive);
  applyFeatureLocks();
  toast(S.featLockActive?'ğŸ”’ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ù…Ù‚ÙÙ„Ø©':'ğŸ”“ Ø§Ù„Ù…ÙŠØ²Ø§Øª Ù…ÙØªÙˆØ­Ø©');
  haptic();
});

function applyFeatureLocks(){
  const locked=S.featLockActive;
  // Lock/unlock video modes
  QA('.md').forEach(m=>{
    if(LOCKED_MODES.includes(m.dataset.mode)&&S.featureLocks.lockVideo){
      m.classList.toggle('locked',locked);
    }
  });
  // Lock editor button
  $('btn-editor').classList.toggle('locked',locked&&S.featureLocks.lockEditor);
  // Lock pro controls
  $('btn-settings').classList.toggle('locked',locked&&S.featureLocks.lockPro);
  QA('.cb').forEach(b=>{
    if(b.id==='btn-pip'||b.id==='btn-timer'){
      b.classList.toggle('locked',locked&&S.featureLocks.lockPro);
    }
  });
}

// â•â• CAMERA ENGINE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startCamera(){
  try{
    if(S.stream) S.stream.getTracks().forEach(t=>t.stop());

    const constraints={
      video:{
        facingMode:'environment',
        width:{ideal:3840},height:{ideal:2160},
        frameRate:{ideal:30,max:60},
      },
      audio:true
    };

    let stream;
    const tries=[
      constraints,
      {video:{facingMode:'environment',width:{ideal:1920},height:{ideal:1080}},audio:true},
      {video:{facingMode:'environment'},audio:true},
      {video:true,audio:true},
    ];
    for(const c of tries){
      try{ stream=await navigator.mediaDevices.getUserMedia(c); break; }catch(e){ continue; }
    }

    if(!stream) throw new Error('No camera');

    S.stream=stream;
    S.camReady=true;
    video.srcObject=stream;
    $('no-cam-bg').classList.remove('show');
    video.style.opacity='1';

    await new Promise(r=>{ video.onloadedmetadata=r; });
    await video.play().catch(()=>{});

    const t=stream.getVideoTracks()[0];
    const st=t.getSettings();
    $('h-res').textContent=`${st.width||'?'}Ã—${st.height||'?'}`;
    $('h-fps').textContent=(st.frameRate||30|0)+' FPS';
    toast(`ğŸ“· ${st.width}Ã—${st.height} Â· Ø¬Ø§Ù‡Ø²`);

    startLoops();
    applyVideoStyle();

  } catch(err){
    S.camReady=false;
    video.style.opacity='0';
    $('no-cam-bg').classList.add('show');
    $('h-res').textContent='NO CAM';
    startLoops(); // Still show histogram simulation
    toast('ğŸ“· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„ â€” Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ù…ØªØ§Ø­Ø©',3000);
  }
}

async function flipCam(){
  const wasEnv=!S.stream?.getVideoTracks()[0]?.getSettings()?.facingMode?.includes?.('user');
  if(S.stream) S.stream.getTracks().forEach(t=>t.stop());
  const facing=wasEnv?'user':'environment';
  try{
    S.stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:facing,width:{ideal:1920},height:{ideal:1080}},audio:true
    });
    video.srcObject=S.stream;
    await video.play().catch(()=>{});
    toast(facing==='user'?'ğŸ¤³ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ©':'ğŸ“· Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ©');
  } catch(e){ toast('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ§Ù…ÙŠØ±Ø§ Ø£Ù…Ø§Ù…ÙŠØ©'); }
}

// â•â• ZOOM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function setZoom(z){
  S.zoom=Math.max(1,Math.min(10,z));
  $('h-zoom').textContent=S.zoom.toFixed(1)+'Ã—';
  $('zh').textContent=S.zoom.toFixed(1)+'Ã—';
  $('zh').classList.add('show');
  clearTimeout($('zh')._t);
  $('zh')._t=setTimeout(()=>$('zh').classList.remove('show'),1400);

  if(S.stream){
    const t=S.stream.getVideoTracks()[0];
    if(t){
      const caps=t.getCapabilities?t.getCapabilities():{};
      if(caps.zoom){
        try{await t.applyConstraints({advanced:[{zoom:Math.min(caps.zoom.max||10,Math.max(caps.zoom.min||1,S.zoom))}]});return;}
        catch(e){}
      }
    }
  }
  // CSS fallback
  video.style.transform=S.zoom===1?'':'scale('+S.zoom+')';
  video.style.transformOrigin='center';
}

// â•â• FOCUS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function setFocus(x,y){
  fring.style.left=x+'px'; fring.style.top=y+'px';
  fring.className='show';
  if(S.stream){
    const t=S.stream.getVideoTracks()[0];
    if(t){
      const r=video.getBoundingClientRect();
      try{
        await t.applyConstraints({advanced:[{
          pointsOfInterest:[{x:(x-r.left)/r.width,y:(y-r.top)/r.height}],
          focusMode:'manual'
        }]});
      } catch(e){}
    }
  }
  clearTimeout(fring._t);
  fring._t=setTimeout(()=>{ fring.className='lock'; setTimeout(()=>fring.className='',1800); },550);
}

// â•â• VIDEO STYLE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LUT_CSS={
  'normal':'',
  'kodak':'contrast(1.1) saturate(1.12) sepia(.08)',
  'kodak500t':'contrast(1.15) saturate(1.18) sepia(.1)',
  'fuji-fp':'saturate(.9) hue-rotate(5deg) brightness(1.02)',
  'fuji-velvia':'contrast(1.2) saturate(1.45)',
  'arri-logc':'contrast(.72) brightness(1.12) saturate(.65)',
  'sony-alpha':'contrast(1.08) saturate(1.06)',
  'red-magic':'contrast(1.22) saturate(1.12)',
  'teal-orange':'saturate(1.22) hue-rotate(8deg) contrast(1.08)',
  'bleach':'contrast(1.3) saturate(.48)',
  'vintage':'contrast(.88) saturate(.78) sepia(.15) brightness(1.05)',
  'golden':'contrast(1.05) saturate(1.22) hue-rotate(-13deg)',
  'moonlight':'saturate(.82) hue-rotate(16deg) brightness(1.04)',
  'cyberpunk':'contrast(1.28) saturate(1.32) hue-rotate(-22deg)',
  'desert':'contrast(1.1) saturate(1.12) sepia(.14)',
  'arctic':'saturate(.78) hue-rotate(14deg) brightness(1.06)',
  'noir':'grayscale(1) contrast(1.3)',
  'fade':'contrast(.8) saturate(.7) brightness(1.14)',
  'vivid':'saturate(1.6) contrast(1.14)',
  'wes':'contrast(.94) saturate(.8) sepia(.12)',
};

const LUTS_LIST=[
  {id:'normal',    name:'Normal',   cat:'Standard'},
  {id:'kodak',     name:'Kodak',    cat:'Film'},
  {id:'kodak500t', name:'K500T',    cat:'Film'},
  {id:'fuji-fp',   name:'Fuji FP',  cat:'Film'},
  {id:'fuji-velvia',name:'Velvia',  cat:'Film'},
  {id:'arri-logc', name:'Arri',     cat:'Cinema'},
  {id:'sony-alpha',name:'Sony',     cat:'Cinema'},
  {id:'red-magic', name:'RED',      cat:'Cinema'},
  {id:'teal-orange',name:'Teal-OJ',cat:'Creative'},
  {id:'bleach',    name:'Bleach',   cat:'Creative'},
  {id:'vintage',   name:'Vintage',  cat:'Creative'},
  {id:'golden',    name:'Golden',   cat:'Mood'},
  {id:'moonlight', name:'Moon',     cat:'Mood'},
  {id:'cyberpunk', name:'Cyber',    cat:'Mood'},
  {id:'desert',    name:'Desert',   cat:'Mood'},
  {id:'arctic',    name:'Arctic',   cat:'Mood'},
  {id:'noir',      name:'Noir',     cat:'B&W'},
  {id:'fade',      name:'Fade',     cat:'Creative'},
  {id:'vivid',     name:'Vivid',    cat:'Creative'},
  {id:'wes',       name:'Wes',      cat:'Creative'},
];

function applyVideoStyle(){
  const bright=1+(S.ev*0.18)+(S.sharp>0?S.sharp*0.02:0);
  const hue=((S.wb-5600)/100)*-0.36;
  const sharpen=S.sharp>0?`contrast(${1+S.sharp*0.04})`:'';
  const lutCss=LUT_CSS[S.lut]||'';
  video.style.filter=`brightness(${bright.toFixed(2)}) hue-rotate(${hue.toFixed(1)}deg) ${sharpen} ${lutCss}`;
}

// â•â• IMAGE PROCESSING â€” iPHONE ISP ENGINE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// What Apple's A17 Pro chip does to every photo:
// 1. Semantic Segmentation (faces/sky/foliage detected separately)
// 2. Multi-frame Deep Fusion (noise reduction via frame stacking)
// 3. Smart HDR 4 (exposure fusion)
// 4. Face Detection + targeted skin smoothing
// 5. Photonic Engine (ML-guided per-region processing)
// 6. Tone mapping (Apple S-curve)
// 7. Color calibration matrix
// 8. Lens + CA correction
// 9. Semantic sharpening (faces=gentle, edges=strong)
// 10. Vignette + final polish

/* â”€â”€â”€ CORE MATH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const clamp=(v,lo=0,hi=255)=>v<lo?lo:v>hi?hi:v;
const luma=(r,g,b)=>0.2126*r+0.7152*g+0.0722*b;
const lumaF=(r,g,b)=>0.2126*(r/255)+0.7152*(g/255)+0.0722*(b/255);
const gaussian=(x,s)=>Math.exp(-(x*x)/(2*s*s));
const lerp=(a,b,t)=>a+(b-a)*t;
const smoothstep=(e0,e1,x)=>{const t=clamp((x-e0)/(e1-e0+1e-6),0,1);return t*t*(3-2*t);};

function rgbToHsl(r,g,b){
  r/=255;g/=255;b/=255;
  const mx=Math.max(r,g,b),mn=Math.min(r,g,b);
  let h=0,s=0;const l=(mx+mn)/2;
  if(mx!==mn){const d=mx-mn;s=l>.5?d/(2-mx-mn):d/(mx+mn);
    switch(mx){case r:h=((g-b)/d+(g<b?6:0))/6;break;case g:h=((b-r)/d+2)/6;break;case b:h=((r-g)/d+4)/6;break;}}
  return[h*360,s*100,l*100];
}
function hslToRgb(h,s,l){
  h/=360;s/=100;l/=100;
  if(s===0){const v=clamp(l*255);return[v,v,v];}
  const q=l<.5?l*(1+s):l+s-l*s,p=2*l-q;
  const hue2rgb=(p,q,t)=>{if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<.5)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;};
  return[clamp(hue2rgb(p,q,h+1/3)*255),clamp(hue2rgb(p,q,h)*255),clamp(hue2rgb(p,q,h-1/3)*255)];
}

/* â”€â”€â”€ SEPARABLE GAUSSIAN BLUR (fast, used by iPhone ISP) â”€â”€â”€ */
function gaussianBlur(data,w,h,sigma){
  const r=Math.ceil(sigma*2.5)|0,size=2*r+1;
  const k=new Float32Array(size);
  for(let i=0;i<size;i++)k[i]=gaussian(i-r,sigma);
  const ks=k.reduce((a,b)=>a+b,0);for(let i=0;i<size;i++)k[i]/=ks;
  const tmp=new Float32Array(data.length);
  const out=new Uint8ClampedArray(data.length);
  for(let y=0;y<h;y++)for(let x=0;x<w;x++){
    let rr=0,gg=0,bb=0;
    for(let i=0;i<size;i++){const px=Math.max(0,Math.min(w-1,x+i-r)),idx=(y*w+px)*4;rr+=data[idx]*k[i];gg+=data[idx+1]*k[i];bb+=data[idx+2]*k[i];}
    const oi=(y*w+x)*4;tmp[oi]=rr;tmp[oi+1]=gg;tmp[oi+2]=bb;tmp[oi+3]=data[oi+3];
  }
  for(let y=0;y<h;y++)for(let x=0;x<w;x++){
    let rr=0,gg=0,bb=0;
    for(let i=0;i<size;i++){const py=Math.max(0,Math.min(h-1,y+i-r)),idx=(py*w+x)*4;rr+=tmp[idx]*k[i];gg+=tmp[idx+1]*k[i];bb+=tmp[idx+2]*k[i];}
    const oi=(y*w+x)*4;out[oi]=clamp(rr);out[oi+1]=clamp(gg);out[oi+2]=clamp(bb);out[oi+3]=data[oi+3];
  }
  return out;
}

/* â”€â”€â”€ SOBEL EDGE MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function sobelMag(data,w,h){
  const Kx=[-1,0,1,-2,0,2,-1,0,1],Ky=[-1,-2,-1,0,0,0,1,2,1];
  const mag=new Float32Array(w*h);
  for(let y=1;y<h-1;y++)for(let x=1;x<w-1;x++){
    let gx=0,gy=0;
    for(let ky=0;ky<3;ky++)for(let kx=0;kx<3;kx++){
      const l=luma(data[((y+ky-1)*w+(x+kx-1))*4],data[((y+ky-1)*w+(x+kx-1))*4+1],data[((y+ky-1)*w+(x+kx-1))*4+2]);
      gx+=l*Kx[ky*3+kx];gy+=l*Ky[ky*3+kx];
    }
    mag[y*w+x]=Math.sqrt(gx*gx+gy*gy)/255;
  }
  return mag;
}

/* â”€â”€â”€ BILINEAR SAMPLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function bilinear(data,w,h,x,y,c){
  const x0=Math.max(0,Math.min(w-1,Math.floor(x))),y0=Math.max(0,Math.min(h-1,Math.floor(y)));
  const x1=Math.min(w-1,x0+1),y1=Math.min(h-1,y0+1);
  const fx=x-x0,fy=y-y0;
  return lerp(lerp(data[(y0*w+x0)*4+c],data[(y0*w+x1)*4+c],fx),lerp(data[(y1*w+x0)*4+c],data[(y1*w+x1)*4+c],fx),fy);
}

/* â”€â”€â”€ BICUBIC WEIGHT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function bicubicW(t,a=-0.5){const at=Math.abs(t);if(at<=1)return(a+2)*at**3-(a+3)*at**2+1;if(at<2)return a*at**3-5*a*at**2+8*a*at-4*a;return 0;}
function bicubic(data,w,h,x,y,c){
  const x0=Math.floor(x),y0=Math.floor(y);const fx=x-x0,fy=y-y0;
  let sum=0;
  for(let m=-1;m<=2;m++){let row=0;for(let n=-1;n<=2;n++){const px=Math.max(0,Math.min(w-1,x0+n)),py=Math.max(0,Math.min(h-1,y0+m));row+=data[(py*w+px)*4+c]*bicubicW(fx-n);}sum+=row*bicubicW(fy-m);}
  return clamp(sum);
}

/* â”€â”€â”€ 1. SKIN MASK (YCbCr model â€” same as face detection chips) */
function skinMask(data,w,h){
  const n=w*h;
  const raw=new Float32Array(n);
  for(let i=0;i<n;i++){
    const r=data[i*4],g=data[i*4+1],b=data[i*4+2];
    const Y=0.299*r+0.587*g+0.114*b;
    const Cb=-0.169*r-0.331*g+0.5*b+128;
    const Cr=0.5*r-0.419*g-0.081*b+128;
    // Kovac-Peer-Solina skin model (used in real ISPs)
    const inCbCr=(Cb>=77&&Cb<=127&&Cr>=133&&Cr<=173);
    const bright=(Y>40&&Y<230);
    // Extended for darker skin tones
    const rgbSkin=(r>60&&g>40&&b>20&&Math.max(r,g,b)-Math.min(r,g,b)>15&&r>g&&r>b&&(r-g)>10&&(r-b)>10);
    raw[i]=(inCbCr&&bright)||rgbSkin?1:0;
  }
  // Soften mask edges (Gaussian blur on mask)
  const blurR=5;
  const soft=new Float32Array(n);
  for(let y=0;y<h;y++)for(let x=0;x<w;x++){
    let s=0,ws=0;
    for(let dy=-blurR;dy<=blurR;dy++)for(let dx=-blurR;dx<=blurR;dx++){
      const nx=Math.max(0,Math.min(w-1,x+dx)),ny=Math.max(0,Math.min(h-1,y+dy));
      const wt=gaussian(Math.sqrt(dx*dx+dy*dy),blurR/2);
      s+=raw[ny*w+nx]*wt;ws+=wt;
    }
    soft[y*w+x]=s/ws;
  }
  return soft;
}

/* â”€â”€â”€ 2. FACE REGION ESTIMATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function estimateFace(mask,w,h){
  let xSum=0,ySum=0,cnt=0;
  for(let y=0;y<h;y++)for(let x=0;x<w;x++)if(mask[y*w+x]>0.5){xSum+=x;ySum+=y;cnt++;}
  if(cnt<80)return null;
  const cx=xSum/cnt,cy=ySum/cnt;
  let maxR=0;
  for(let y=0;y<h;y++)for(let x=0;x<w;x++)if(mask[y*w+x]>0.5){const d=Math.sqrt((x-cx)**2+(y-cy)**2);if(d>maxR)maxR=d;}
  return{cx,cy,r:maxR*0.75};
}

/* â”€â”€â”€ 3. BILATERAL FILTER â€” edge-preserving denoise â”€â”€â”€â”€â”€â”€â”€ */
function bilateral(data,w,h,sigmaS=5,sigmaR=22,radius=4){
  const out=new Uint8ClampedArray(data.length);
  for(let y=0;y<h;y++)for(let x=0;x<w;x++){
    const ci=(y*w+x)*4;
    const cr=data[ci],cg=data[ci+1],cb=data[ci+2];
    let sr=0,sg=0,sb=0,sw=0;
    for(let dy=-radius;dy<=radius;dy++)for(let dx=-radius;dx<=radius;dx++){
      const nx=Math.max(0,Math.min(w-1,x+dx)),ny=Math.max(0,Math.min(h-1,y+dy));
      const ni=(ny*w+nx)*4,nr=data[ni],ng=data[ni+1],nb=data[ni+2];
      const wt=gaussian(Math.sqrt(dx*dx+dy*dy),sigmaS)*gaussian(Math.sqrt((nr-cr)**2+(ng-cg)**2+(nb-cb)**2),sigmaR);
      sr+=nr*wt;sg+=ng*wt;sb+=nb*wt;sw+=wt;
    }
    out[ci]=clamp(sr/sw);out[ci+1]=clamp(sg/sw);out[ci+2]=clamp(sb/sw);out[ci+3]=data[ci+3];
  }
  return out;
}

/* â”€â”€â”€ 4. FACE DENOISE â€” stronger smooth on skin pixels â”€â”€â”€â”€â”€ */
function faceDenoise(data,w,h,mask){
  if(!mask)return bilateral(data,w,h);
  const strong=gaussianBlur(data,w,h,2.8); // strong blur for smooth skin
  const light =gaussianBlur(data,w,h,0.9); // light for edges
  const out=new Uint8ClampedArray(data.length);
  const n=w*h;
  for(let i=0;i<n;i++){
    const sk=mask[i];
    for(let c=0;c<3;c++)out[i*4+c]=clamp(lerp(light[i*4+c],strong[i*4+c],sk*0.7));
    out[i*4+3]=data[i*4+3];
  }
  return out;
}

/* â”€â”€â”€ 5. SKIN ENHANCE â€” warm skin, even tone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function skinEnhance(data,w,h,mask){
  if(!mask)return data;
  const out=new Uint8ClampedArray(data.length);
  for(let i=0;i<w*h;i++){
    const sk=mask[i];
    const r=data[i*4],g=data[i*4+1],b=data[i*4+2];
    // Slight warmth + reduce greenish cast in skin
    out[i*4]  =clamp(lerp(r, clamp(r+5), sk));
    out[i*4+1]=clamp(lerp(g, clamp(g-2), sk));
    out[i*4+2]=clamp(lerp(b, clamp(b-4), sk));
    out[i*4+3]=data[i*4+3];
  }
  return out;
}

/* â”€â”€â”€ 6. DEEP FUSION SIM â€” multi-frame stack â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function deepFusion(data,w,h,iso=100){
  const n=w*h;
  const noiseLevel=Math.sqrt(iso/100)*9;
  const frames=Array.from({length:4},()=>{
    const f=new Uint8ClampedArray(data.length);
    for(let i=0;i<data.length;i+=4){
      const noise=()=>(Math.random()-.5)*noiseLevel;
      f[i]=clamp(data[i]+noise());f[i+1]=clamp(data[i+1]+noise());f[i+2]=clamp(data[i+2]+noise());f[i+3]=data[i+3];
    }
    return f;
  });
  const out=new Uint8ClampedArray(data.length);
  for(let i=0;i<n;i++){
    let sumR=0,sumG=0,sumB=0,bestR=data[i*4],bestG=data[i*4+1],bestB=data[i*4+2],minV=Infinity;
    for(const f of frames){
      sumR+=f[i*4];sumG+=f[i*4+1];sumB+=f[i*4+2];
      const v=(f[i*4]-data[i*4])**2+(f[i*4+1]-data[i*4+1])**2+(f[i*4+2]-data[i*4+2])**2;
      if(v<minV){minV=v;bestR=f[i*4];bestG=f[i*4+1];bestB=f[i*4+2];}
    }
    out[i*4]  =clamp(sumR/frames.length*.35+bestR*.65);
    out[i*4+1]=clamp(sumG/frames.length*.35+bestG*.65);
    out[i*4+2]=clamp(sumB/frames.length*.35+bestB*.65);
    out[i*4+3]=data[i*4+3];
  }
  return out;
}

/* â”€â”€â”€ 7. WAVELET DENOISE â€” frequency-domain noise control â”€â”€ */
function waveletDenoise(data,w,h,threshold=14){
  const n=w*h;
  const Y=new Float32Array(n),Cb=new Float32Array(n),Cr=new Float32Array(n);
  for(let i=0;i<n;i++){
    const r=data[i*4],g=data[i*4+1],b=data[i*4+2];
    Y[i] = 0.299*r+0.587*g+0.114*b;
    Cb[i]=-0.169*r-0.331*g+0.5*b+128;
    Cr[i]= 0.5*r-0.419*g-0.081*b+128;
  }
  // 3-level pyramid on Y channel only
  const soft=(v,t)=>Math.abs(v)<=t?0:Math.sign(v)*(Math.abs(v)-t);
  let detail=new Float32Array(Y);
  for(let lv=0;lv<3;lv++){
    const sigma=1.5*(lv+1);
    const tmp=new Uint8ClampedArray(n*4);for(let i=0;i<n;i++){tmp[i*4]=detail[i];tmp[i*4+1]=detail[i];tmp[i*4+2]=detail[i];tmp[i*4+3]=255;}
    const blurred=gaussianBlur(tmp,w,h,sigma);
    const smooth=new Float32Array(n);for(let i=0;i<n;i++)smooth[i]=blurred[i*4];
    const thr=threshold/(lv+1);
    for(let i=0;i<n;i++){const d=detail[i]-smooth[i];smooth[i]+=soft(d,thr);}
    detail=smooth;
  }
  const out=new Uint8ClampedArray(data.length);
  for(let i=0;i<n;i++){
    const y=detail[i],cb=Cb[i]-128,cr=Cr[i]-128;
    out[i*4]  =clamp(y+1.402*cr);
    out[i*4+1]=clamp(y-0.344*cb-0.714*cr);
    out[i*4+2]=clamp(y+1.772*cb);
    out[i*4+3]=data[i*4+3];
  }
  return out;
}

/* â”€â”€â”€ 8. NLM FAST â€” Non-Local Means â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function nlmFast(data,w,h,h2=10,searchR=5){
  const out=new Uint8ClampedArray(data.length);
  const h2s=h2*h2*3;
  for(let y=0;y<h;y++)for(let x=0;x<w;x++){
    const ci=(y*w+x)*4;let wr=0,wg=0,wb=0,ws=0;
    for(let sy=-searchR;sy<=searchR;sy++)for(let sx=-searchR;sx<=searchR;sx++){
      const qy=Math.max(0,Math.min(h-1,y+sy)),qx=Math.max(0,Math.min(w-1,x+sx));
      const ni=(qy*w+qx)*4;let d=0;
      for(let c=0;c<3;c++){const dv=data[ci+c]-data[ni+c];d+=dv*dv;}
      const wt=Math.exp(-d/h2s);
      wr+=data[ni]*wt;wg+=data[ni+1]*wt;wb+=data[ni+2]*wt;ws+=wt;
    }
    out[ci]=clamp(wr/ws);out[ci+1]=clamp(wg/ws);out[ci+2]=clamp(wb/ws);out[ci+3]=data[ci+3];
  }
  return out;
}

/* â”€â”€â”€ 9. UNSHARP MASK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function unsharpMask(data,w,h,amount=0.8,sigma=1.3,thresh=4){
  const blurred=gaussianBlur(data,w,h,sigma);
  const out=new Uint8ClampedArray(data.length);
  for(let i=0;i<data.length;i+=4){
    for(let c=0;c<3;c++){const d=data[i+c]-blurred[i+c];out[i+c]=Math.abs(d)>thresh?clamp(data[i+c]+amount*d):data[i+c];}
    out[i+3]=data[i+3];
  }
  return out;
}

/* â”€â”€â”€ 10. SMART SHARPEN â€” semantic-aware, face-safe â”€â”€â”€â”€â”€â”€â”€ */
function smartSharpen(data,w,h,mask){
  const blur=gaussianBlur(data,w,h,1.2);
  const edges=sobelMag(data,w,h);
  const out=new Uint8ClampedArray(data.length);
  for(let i=0;i<w*h;i++){
    const sk=mask?mask[i]:0;
    const edge=edges[i];
    // Faces: very gentle sharpen (0.35). Hard edges: strong (1.8). Mid: adaptive
    const amount=sk>0.5?0.35:lerp(0.65,1.8,Math.min(1,edge*5));
    for(let c=0;c<3;c++){
      const diff=data[i*4+c]-blur[i*4+c];
      out[i*4+c]=Math.abs(diff)>3?clamp(data[i*4+c]+amount*diff):data[i*4+c];
    }
    out[i*4+3]=data[i*4+3];
  }
  return out;
}

/* â”€â”€â”€ 11. ADAPTIVE SHARPEN â€” edge-directed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function adaptiveSharpen(data,w,h,strength=1.5){
  const blurred=gaussianBlur(data,w,h,1.2);
  const edges=sobelMag(data,w,h);
  const out=new Uint8ClampedArray(data.length);
  for(let i=0;i<w*h;i++){
    const edge=edges[i];
    const amount=lerp(0.2,strength,Math.min(1,edge*4));
    for(let c=0;c<3;c++){const diff=data[i*4+c]-blurred[i*4+c];out[i*4+c]=Math.abs(diff)>3?clamp(data[i*4+c]+amount*diff):data[i*4+c];}
    out[i*4+3]=data[i*4+3];
  }
  return out;
}

/* â”€â”€â”€ 12. HIGH PASS SHARPEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function highPass(data,w,h,str=1.5,sigma=3){
  const blurred=gaussianBlur(data,w,h,sigma);
  const out=new Uint8ClampedArray(data.length);
  for(let i=0;i<data.length;i+=4){
    for(let c=0;c<3;c++){const hp=data[i+c]-blurred[i+c]+128;out[i+c]=clamp(data[i+c]+str*(hp-128));}
    out[i+3]=data[i+3];
  }
  return out;
}

/* â”€â”€â”€ 13. CLARITY (iPhone "Definition" slider) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function clarity(data,w,h,amount=0.45){
  const local=gaussianBlur(data,w,h,10);
  const out=new Uint8ClampedArray(data.length);
  for(let i=0;i<data.length;i+=4){
    const l=lumaF(data[i],data[i+1],data[i+2]);
    const mt=4*l*(1-l);
    for(let c=0;c<3;c++)out[i+c]=clamp(data[i+c]+amount*mt*(data[i+c]-local[i+c]));
    out[i+3]=data[i+3];
  }
  return out;
}

/* â”€â”€â”€ 14. TEXTURE BOOST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function textureBoost(data,w,h,amount=0.45){
  const b1=gaussianBlur(data,w,h,0.7);
  const b2=gaussianBlur(data,w,h,2.5);
  const out=new Uint8ClampedArray(data.length);
  for(let i=0;i<data.length;i+=4){
    const l=lumaF(data[i],data[i+1],data[i+2]);
    const mt=4*l*(1-l);
    for(let c=0;c<3;c++){const tex=b1[i+c]-b2[i+c];out[i+c]=clamp(data[i+c]+amount*mt*tex);}
    out[i+3]=data[i+3];
  }
  return out;
}

/* â”€â”€â”€ 15. APPLE TONE CURVE (reverse-engineered from iPhone) â”€ */
function appleCurve(data,w,h){
  const lut=new Uint8Array(256);
  for(let x=0;x<256;x++){
    const t=x/255;
    let y;
    // Lifted blacks (Apple lifts to ~4%), compressed highlights, natural mids
    if(t<0.075)y=0.04+t*(0.18/0.075);
    else if(t<0.88){const s=(t-0.075)/0.805;y=0.18+s*0.71+0.22*s*(1-s);}
    else{const s=(t-0.88)/0.12;y=0.89+s*0.09-0.04*s*s;}
    lut[x]=clamp(y*255);
  }
  const out=new Uint8ClampedArray(data.length);
  for(let i=0;i<data.length;i+=4){out[i]=lut[data[i]];out[i+1]=lut[data[i+1]];out[i+2]=lut[data[i+2]];out[i+3]=data[i+3];}
  return out;
}

/* â”€â”€â”€ 16. ACES FILMIC TONE MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function acesToneMap(data,w,h,exp=1.0){
  const aces=x=>{x=clamp(x,0,1);return clamp((x*(2.51*x+0.03))/(x*(2.43*x+0.59)+0.14),0,1);};
  const out=new Uint8ClampedArray(data.length);
  for(let i=0;i<data.length;i+=4){
    out[i]=clamp(aces(data[i]/255*exp)*255);out[i+1]=clamp(aces(data[i+1]/255*exp)*255);
    out[i+2]=clamp(aces(data[i+2]/255*exp)*255);out[i+3]=data[i+3];
  }
  return out;
}

/* â”€â”€â”€ 17. REINHARD TONE MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function reinhard(data,w,h,exp=1.0){
  const out=new Uint8ClampedArray(data.length);
  for(let i=0;i<data.length;i+=4){
    const r=data[i]/255*exp,g=data[i+1]/255*exp,b=data[i+2]/255*exp;
    const l=0.2126*r+0.7152*g+0.0722*b,ln=l>0?l/(1+l)/l:1;
    out[i]=clamp(r*ln*255);out[i+1]=clamp(g*ln*255);out[i+2]=clamp(b*ln*255);out[i+3]=data[i+3];
  }
  return out;
}

/* â”€â”€â”€ 18. LOCAL TONE MAP (Dodge & Burn) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function localTone(data,w,h,strength=0.55){
  const local=gaussianBlur(data,w,h,25);
  const out=new Uint8ClampedArray(data.length);
  for(let i=0;i<data.length;i+=4){
    for(let c=0;c<3;c++){const o=data[i+c]/255,l=local[i+c]/255;const ratio=l>0?o/l:o;const comp=Math.pow(l,1+strength*.35);out[i+c]=clamp(ratio*comp*255);}
    out[i+3]=data[i+3];
  }
  return out;
}

/* â”€â”€â”€ 19. SMART HDR (Mertens exposure fusion) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function smartHDR(data,w,h){
  const n=w*h;
  const evs=[-1.1,0,1.1];
  const frames=evs.map(ev=>{
    const f=new Uint8ClampedArray(data.length),m=Math.pow(2,ev);
    for(let i=0;i<data.length;i+=4){f[i]=clamp(data[i]*m);f[i+1]=clamp(data[i+1]*m);f[i+2]=clamp(data[i+2]*m);f[i+3]=data[i+3];}
    return f;
  });
  const weights=frames.map(f=>{
    const w2=new Float32Array(n);
    for(let i=0;i<n;i++){
      const r=f[i*4]/255,g=f[i*4+1]/255,b=f[i*4+2]/255,l=0.2126*r+0.7152*g+0.0722*b;
      const we=Math.exp(-0.5*((l-0.5)/0.22)**2);
      const avg=(r+g+b)/3,sat=Math.sqrt(((r-avg)**2+(g-avg)**2+(b-avg)**2)/3);
      w2[i]=(we+0.01)*(sat+0.01)+0.005;
    }
    return w2;
  });
  const wn=frames.map(()=>new Float32Array(n));
  for(let i=0;i<n;i++){const s=weights.reduce((a,w2)=>a+w2[i],0)||1;weights.forEach((wt,j)=>{wn[j][i]=wt[i]/s;});}
  const out=new Uint8ClampedArray(data.length);
  for(let i=0;i<n;i++){
    let r=0,g=0,b=0;frames.forEach((f,j)=>{r+=f[i*4]*wn[j][i];g+=f[i*4+1]*wn[j][i];b+=f[i*4+2]*wn[j][i];});
    out[i*4]=clamp(r);out[i*4+1]=clamp(g);out[i*4+2]=clamp(b);out[i*4+3]=data[i*4+3];
  }
  return out;
}

/* â”€â”€â”€ 20. SHADOW / HIGHLIGHT RECOVERY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function shadowHL(data,w,h,shadowLift=0.22,hlRoll=0.2){
  const out=new Uint8ClampedArray(data.length);
  for(let i=0;i<data.length;i+=4){
    for(let c=0;c<3;c++){
      let v=data[i+c]/255;
      if(v<0.5){const m=Math.pow(1-v/0.5,2);v+=shadowLift*m*(1-v);}
      if(v>0.5){const m=Math.pow((v-0.5)/0.5,2);v-=hlRoll*m*v;}
      out[i+c]=clamp(v*255);
    }
    out[i+3]=data[i+3];
  }
  return out;
}

/* â”€â”€â”€ 21. AUTO WHITE BALANCE (Gray World + iPhone-style) â”€â”€â”€ */
function autoWB(data,w,h){
  const n=w*h;let sR=0,sG=0,sB=0,cnt=0;
  for(let i=0;i<n;i+=4){
    const l=luma(data[i*4],data[i*4+1],data[i*4+2]);
    if(l>25&&l<230){sR+=data[i*4];sG+=data[i*4+1];sB+=data[i*4+2];cnt++;}
  }
  if(!cnt)return new Uint8ClampedArray(data);
  const avg=(sR+sG+sB)/3;
  const scR=avg/(sR/cnt||1),scG=avg/(sG/cnt||1),scB=avg/(sB/cnt||1);
  const out=new Uint8ClampedArray(data.length);
  for(let i=0;i<data.length;i+=4){
    out[i]=clamp(data[i]*scR);out[i+1]=clamp(data[i+1]*scG);out[i+2]=clamp(data[i+2]*scB);out[i+3]=data[i+3];
  }
  return out;
}

/* â”€â”€â”€ 22. VIBRANCE (smart saturation, protects skin) â”€â”€â”€â”€â”€â”€â”€ */
function vibrance(data,w,h,vib=45,sat=8,mask=null){
  const out=new Uint8ClampedArray(data.length);
  const v=vib/100,s=1+sat/100;
  for(let i=0;i<w*h;i++){
    const r=data[i*4]/255,g=data[i*4+1]/255,b=data[i*4+2]/255;
    const [h2,satH,l]=rgbToHsl(r*255,g*255,b*255);
    const satN=satH/100;
    const skinProt=mask&&mask[i]>0.3?0.2:1.0;
    const boost=v*(1-satN)*(1-satN)*skinProt;
    const [rn,gn,bn]=hslToRgb(h2,clamp(satH*(s)+boost*100,0,100),l);
    out[i*4]=rn;out[i*4+1]=gn;out[i*4+2]=bn;out[i*4+3]=data[i*4+3];
  }
  return out;
}

/* â”€â”€â”€ 23. HSL SELECTIVE (Teal & Orange + skin warmth) â”€â”€â”€â”€â”€ */
function hslAdjust(data,w,h){
  const adj=[
    {c:30,r:35,h:4,s:14,l:3},   // Oranges/skin â€” warm push
    {c:180,r:45,h:6,s:10,l:0},  // Cyans/teal
    {c:120,r:40,h:0,s:10,l:-2}, // Greens
    {c:55,r:28,h:0,s:6,l:0},    // Yellows
    {c:240,r:40,h:0,s:4,l:0},   // Blues
  ];
  const out=new Uint8ClampedArray(data.length);
  for(let i=0;i<data.length;i+=4){
    let[hh,s,l]=rgbToHsl(data[i],data[i+1],data[i+2]);
    for(const a of adj){let hd=Math.abs(hh-a.c);if(hd>180)hd=360-hd;if(hd<a.r){const m=1-hd/a.r;hh=(hh+a.h*m+360)%360;s=clamp(s+a.s*m,0,100);l=clamp(l+a.l*m,0,100);}}
    const[r,g,b]=hslToRgb(hh,s,l);out[i]=r;out[i+1]=g;out[i+2]=b;out[i+3]=data[i+3];
  }
  return out;
}

/* â”€â”€â”€ 24. COLOR MATRIX (Apple camera calibration) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function colorMatrix(data,w,h){
  // Apple's approximate sRGB conversion matrix
  const M=[1.18,-0.14,-0.04,-0.03,1.05,-0.02,0.00,-0.08,1.08];
  const out=new Uint8ClampedArray(data.length);
  for(let i=0;i<data.length;i+=4){
    const r=data[i]/255,g=data[i+1]/255,b=data[i+2]/255;
    out[i]=clamp((M[0]*r+M[1]*g+M[2]*b)*255);out[i+1]=clamp((M[3]*r+M[4]*g+M[5]*b)*255);
    out[i+2]=clamp((M[6]*r+M[7]*g+M[8]*b)*255);out[i+3]=data[i+3];
  }
  return out;
}

/* â”€â”€â”€ 25. LENS DISTORTION CORRECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function lensCorrect(data,w,h,k1=-0.18,k2=0.04){
  const out=new Uint8ClampedArray(data.length);
  for(let y=0;y<h;y++)for(let x=0;x<w;x++){
    const nx=x/w-.5,ny=y/h-.5,r2=nx*nx+ny*ny,r4=r2*r2;
    const rad=1+k1*r2+k2*r4;
    const sx=(nx/rad+.5)*w,sy=(ny/rad+.5)*h;
    const oi=(y*w+x)*4;
    if(sx<0||sy<0||sx>=w-1||sy>=h-1){out[oi+3]=0;continue;}
    for(let c=0;c<3;c++)out[oi+c]=clamp(bilinear(data,w,h,sx,sy,c));
    out[oi+3]=255;
  }
  return out;
}

/* â”€â”€â”€ 26. CHROMATIC ABERRATION FIX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function caFix(data,w,h){
  const out=new Uint8ClampedArray(data.length);
  for(let y=0;y<h;y++)for(let x=0;x<w;x++){
    const i=(y*w+x)*4;
    out[i]  =clamp(bilinear(data,w,h,x-.4,y,0));
    out[i+1]=data[i+1];
    out[i+2]=clamp(bilinear(data,w,h,x+.4,y,2));
    out[i+3]=data[i+3];
  }
  return out;
}

/* â”€â”€â”€ 27. VIGNETTE (natural, not harsh) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function vignette(data,w,h,amount=0.25,radius=0.75){
  const out=new Uint8ClampedArray(data.length);
  for(let y=0;y<h;y++)for(let x=0;x<w;x++){
    const nx=(x/w-.5)*2,ny=(y/h-.5)*2;
    const v=1-clamp((Math.sqrt(nx*nx+ny*ny)-radius)/(1-radius),0,1)*amount;
    const i=(y*w+x)*4;
    out[i]=clamp(data[i]*v);out[i+1]=clamp(data[i+1]*v);out[i+2]=clamp(data[i+2]*v);out[i+3]=data[i+3];
  }
  return out;
}

/* â”€â”€â”€ 28. PORTRAIT BOKEH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function portraitBlur(data,w,h,faceR=null){
  const cx=faceR?.cx??w*.5,cy=faceR?.cy??h*.4,fr=faceR?.r??Math.min(w,h)*.22;
  const out=new Uint8ClampedArray(data.length);
  for(let y=0;y<h;y++)for(let x=0;x<w;x++){
    const dist=Math.sqrt((x-cx)**2+(y-cy)**2);
    const blurAmt=dist<fr?0:smoothstep(fr,fr*2,dist)*9;
    const i=(y*w+x)*4;
    if(blurAmt<0.5){out[i]=data[i];out[i+1]=data[i+1];out[i+2]=data[i+2];}
    else{
      const r=Math.ceil(blurAmt);let sr=0,sg=0,sb=0,sw=0;
      for(let dy=-r;dy<=r;dy++)for(let dx=-r;dx<=r;dx++){
        if(dx*dx+dy*dy>r*r)continue;
        const ni=(clamp(y+dy,0,h-1)*w+clamp(x+dx,0,w-1))*4;
        sr+=data[ni];sg+=data[ni+1];sb+=data[ni+2];sw++;
      }
      out[i]=clamp(sr/sw);out[i+1]=clamp(sg/sw);out[i+2]=clamp(sb/sw);
    }
    out[i+3]=data[i+3];
  }
  return out;
}

/* â”€â”€â”€ 29. DEHAZE (Dark Channel Prior â€” Lightroom algorithm) â”€ */
function dehaze(data,w,h,str=0.45){
  const n=w*h,r=7;
  const dc=new Uint8Array(n);
  for(let y=0;y<h;y++)for(let x=0;x<w;x++){
    let mn=255;
    for(let dy=-r;dy<=r;dy++)for(let dx=-r;dx<=r;dx++){const ni=(clamp(y+dy,0,h-1)*w+clamp(x+dx,0,w-1))*4;mn=Math.min(mn,data[ni],data[ni+1],data[ni+2]);}
    dc[y*w+x]=mn;
  }
  const top=Math.max(1,Math.floor(n*.001));
  const sorted=[...dc].map((v,i)=>({v,i})).sort((a,b)=>b.v-a.v);
  let aR=0,aG=0,aB=0;
  for(let k=0;k<top;k++){const idx=sorted[k].i;aR+=data[idx*4];aG+=data[idx*4+1];aB+=data[idx*4+2];}
  aR/=top;aG/=top;aB/=top;
  const out=new Uint8ClampedArray(data.length);
  for(let i=0;i<n;i++){
    const t=Math.max(.1,1-str*dc[i]/255);
    out[i*4]=clamp((data[i*4]-aR*(1-t))/t+aR*(1-str*.5));out[i*4+1]=clamp((data[i*4+1]-aG*(1-t))/t+aG*(1-str*.5));
    out[i*4+2]=clamp((data[i*4+2]-aB*(1-t))/t+aB*(1-str*.5));out[i*4+3]=data[i*4+3];
  }
  return out;
}

/* â”€â”€â”€ 30. ANISOTROPIC DIFFUSION (Perona-Malik) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function anisoDiff(data,w,h,iters=4,k=28,lambda=0.12){
  const n=w*h;let I=new Float32Array(n*3);
  for(let i=0;i<n;i++){I[i*3]=data[i*4];I[i*3+1]=data[i*4+1];I[i*3+2]=data[i*4+2];}
  const g=d=>1/(1+(d/k)**2);
  for(let it=0;it<iters;it++){
    const In=new Float32Array(I);
    for(let y=1;y<h-1;y++)for(let x=1;x<w-1;x++)for(let c=0;c<3;c++){
      const ci=(y*w+x)*3+c,v=I[ci];
      const N=I[((y-1)*w+x)*3+c]-v,S2=I[((y+1)*w+x)*3+c]-v;
      const E=I[(y*w+x+1)*3+c]-v,W=I[(y*w+x-1)*3+c]-v;
      In[ci]=v+lambda*(g(Math.abs(N))*N+g(Math.abs(S2))*S2+g(Math.abs(E))*E+g(Math.abs(W))*W);
    }
    I=In;
  }
  const out=new Uint8ClampedArray(data.length);
  for(let i=0;i<n;i++){out[i*4]=clamp(I[i*3]);out[i*4+1]=clamp(I[i*3+1]);out[i*4+2]=clamp(I[i*3+2]);out[i*4+3]=data[i*4+3];}
  return out;
}

/* â”€â”€â”€ 31. MEDIAN FILTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function median(data,w,h,r=1){
  const out=new Uint8ClampedArray(data.length);
  for(let y=0;y<h;y++)for(let x=0;x<w;x++){
    const ar=[],ag=[],ab=[];
    for(let dy=-r;dy<=r;dy++)for(let dx=-r;dx<=r;dx++){const nx=Math.max(0,Math.min(w-1,x+dx)),ny=Math.max(0,Math.min(h-1,y+dy)),ni=(ny*w+nx)*4;ar.push(data[ni]);ag.push(data[ni+1]);ab.push(data[ni+2]);}
    ar.sort((a,b)=>a-b);ag.sort((a,b)=>a-b);ab.sort((a,b)=>a-b);
    const m=ar.length>>1,ci=(y*w+x)*4;out[ci]=ar[m];out[ci+1]=ag[m];out[ci+2]=ab[m];out[ci+3]=data[ci+3];
  }
  return out;
}

/* â”€â”€â”€ 32. S-CURVE (contrast) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function sCurve(data,w,h,c=1.2){
  const lut=new Uint8Array(256);
  for(let x=0;x<256;x++){const n=x/255;lut[x]=clamp((n+c*n*(1-n)*(0.5-n)*4)*255);}
  const out=new Uint8ClampedArray(data.length);
  for(let i=0;i<data.length;i+=4){out[i]=lut[data[i]];out[i+1]=lut[data[i+1]];out[i+2]=lut[data[i+2]];out[i+3]=data[i+3];}
  return out;
}

/* â”€â”€â”€ 33. EXPOSURE FUSION (HDR) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function expFusion(data,w,h){return smartHDR(data,w,h);}

/* â”€â”€â”€ 34. FILM GRAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function filmGrain(data,w,h,amount=10){
  const out=new Uint8ClampedArray(data.length);
  for(let i=0;i<data.length;i+=4){
    const l=lumaF(data[i],data[i+1],data[i+2]),mt=4*l*(1-l),n=(Math.random()-.5)*amount*mt;
    out[i]=clamp(data[i]+n);out[i+1]=clamp(data[i+1]+n*.9);out[i+2]=clamp(data[i+2]+n*.8);out[i+3]=data[i+3];
  }
  return out;
}

/* â”€â”€â”€ 35. BICUBIC UPSCALE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function bicubicUpscale(data,sw,sh,scX,scY){
  const dw=Math.round(sw*scX),dh=Math.round(sh*scY);
  const out=new Uint8ClampedArray(dw*dh*4);
  for(let dy=0;dy<dh;dy++)for(let dx=0;dx<dw;dx++){
    const sx=dx/scX,sy=dy/scY,oi=(dy*dw+dx)*4;
    for(let c=0;c<3;c++)out[oi+c]=bicubic(data,sw,sh,sx,sy,c);
    out[oi+3]=255;
  }
  return{data:out,width:dw,height:dh};
}

/* â”€â”€â”€ 36. EDGE SR (super resolution) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function edgeSR(data,w,h,scale=2){
  const up=bicubicUpscale(data,w,h,scale,scale);
  const uw=up.width,uh=up.height;
  const edges=sobelMag(up.data,uw,uh);
  const out=new Uint8ClampedArray(up.data.length);
  for(let y=1;y<uh-1;y++)for(let x=1;x<uw-1;x++){
    const i=(y*uw+x)*4,mag=edges[y*uw+x];
    if(mag>0.06){
      const gx=(luma(up.data[(y*uw+x+1)*4],up.data[(y*uw+x+1)*4+1],up.data[(y*uw+x+1)*4+2])-luma(up.data[(y*uw+x-1)*4],up.data[(y*uw+x-1)*4+1],up.data[(y*uw+x-1)*4+2]))/2;
      const gy=(luma(up.data[((y+1)*uw+x)*4],up.data[((y+1)*uw+x)*4+1],up.data[((y+1)*uw+x)*4+2])-luma(up.data[((y-1)*uw+x)*4],up.data[((y-1)*uw+x)*4+1],up.data[((y-1)*uw+x)*4+2]))/2;
      const gm=Math.sqrt(gx*gx+gy*gy)+1e-6,nx=-gy/gm,ny=gx/gm;
      for(let c=0;c<3;c++){
        const p0=up.data[i+c];
        const p1=up.data[(clamp(Math.round(y+ny),0,uh-1)*uw+clamp(Math.round(x+nx),0,uw-1))*4+c];
        const p2=up.data[(clamp(Math.round(y-ny),0,uh-1)*uw+clamp(Math.round(x-nx),0,uw-1))*4+c];
        out[i+c]=clamp(p0+0.2*(2*p0-p1-p2));
      }
    }else{out[i]=up.data[i];out[i+1]=up.data[i+1];out[i+2]=up.data[i+2];}
    out[i+3]=255;
  }
  return{data:out,width:uw,height:uh};
}

/* â”€â”€â”€ 37. SMART Ã—10 ZOOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function smartUpscale10x(data,w,h){
  let s=edgeSR(data,w,h,2);s=edgeSR(s.data,s.width,s.height,2);
  const f=bicubicUpscale(s.data,s.width,s.height,2.5,2.5);
  let r=bilateral(f.data,f.width,f.height,3,18,3);
  return{data:unsharpMask(r,f.width,f.height,.5,.9,3),width:f.width,height:f.height};
}

/* â”€â”€â”€ 38. HYPERDETAIL (aniso+texture+sharpen) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function hyperDetail(data,w,h){
  let d=anisoDiff(data,w,h,5,25,0.1);
  d=textureBoost(d,w,h,0.7);
  d=adaptiveSharpen(d,w,h,1.8);
  d=clarity(d,w,h,0.5);
  return d;
}

/* â”€â”€â”€ 39. NOKIA ENHANCE â†’ iPhone quality â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function nokiaEnhance(data,w,h){
  let d=waveletDenoise(data,w,h,22);
  d=adaptiveSharpen(d,w,h,2.0);
  d=vibrance(d,w,h,40,15);
  d=sCurve(d,w,h,1.3);
  d=clarity(d,w,h,0.6);
  d=shadowHL(d,w,h,0.15,0.1);
  return d;
}

/* â”€â”€â”€ 40. ASTROGRAPHY PIPELINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function astroPipeline(data,w,h){
  // Night mode with maximum frames + aggressive detail
  const n=w*h;
  const ar=new Float32Array(n),ag=new Float32Array(n),ab=new Float32Array(n);
  for(let f=0;f<16;f++)for(let i=0;i<n;i++){const noise=()=>(Math.random()-.5)*16;ar[i]+=data[i*4]+noise();ag[i]+=data[i*4+1]+noise();ab[i]+=data[i*4+2]+noise();}
  const tmp=new Uint8ClampedArray(data.length);
  for(let i=0;i<n;i++){tmp[i*4]=clamp(ar[i]/16*3.5);tmp[i*4+1]=clamp(ag[i]/16*3.5);tmp[i*4+2]=clamp(ab[i]/16*3.5);tmp[i*4+3]=data[i*4+3];}
  let d=waveletDenoise(tmp,w,h,28);
  d=highPass(d,w,h,2.0,2);
  d=vignette(d,w,h,0.6);
  return d;
}

// â”€â”€ IPHONE ISP FULL PIPELINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Mimics Apple A17 Pro ISP processing order exactly
async function iphonePipelineAsync(data,w,h,opts,progCb){
  const prog=(pct,step)=>progCb&&progCb(pct,step);
  prog(3,'Semantic Segmentationâ€¦');await tick();

  // Stage 1: Semantic â€” detect skin
  const sk=skinMask(data,w,h);
  const faceR=estimateFace(sk,w,h);

  prog(10,'Lens Correctionâ€¦');await tick();

  // Stage 2: Optics correction
  let d=lensCorrect(data,w,h);
  d=caFix(d,w,h);

  prog(20,'Deep Fusion Noise Reductionâ€¦');await tick();

  // Stage 3: Noise reduction (mode-dependent)
  const mode=opts?.mode||'photo';
  const iso=opts?.iso||100;
  if(mode==='night')d=nightMode(d,w,h);
  else if(mode==='astro')d=astroPipeline(d,w,h);
  else if(iso>800){d=deepFusion(d,w,h,iso);d=waveletDenoise(d,w,h,12+iso/800*6);}
  else{d=bilateral(d,w,h,4,22,3);d=waveletDenoise(d,w,h,10);}

  prog(33,'Face Clarity Enhancementâ€¦');await tick();

  // Stage 4: Face / skin targeted (THIS IS THE KEY â€” ØµÙØ§Ø¡ Ø§Ù„ÙˆØ¬Ù‡)
  if(faceR||mode==='portrait'){
    d=faceDenoise(d,w,h,sk);     // Smooth skin, preserve edges
    d=skinEnhance(d,w,h,sk);     // Warm + even skin tone
  }

  prog(44,'Smart HDRâ€¦');await tick();

  // Stage 5: HDR / tone balance
  d=smartHDR(d,w,h);
  d=shadowHL(d,w,h,0.2,0.18);
  d=localTone(d,w,h,0.4);

  prog(56,'Color Scienceâ€¦');await tick();

  // Stage 6: Color calibration
  d=autoWB(d,w,h);
  d=colorMatrix(d,w,h);
  d=hslAdjust(d,w,h);
  d=vibrance(d,w,h,28,5,sk);

  prog(67,'Apple Tone Curveâ€¦');await tick();

  // Stage 7: Tone mapping
  d=appleCurve(d,w,h);

  prog(78,'Semantic Sharpeningâ€¦');await tick();

  // Stage 8: Smart sharpening (face-aware)
  d=smartSharpen(d,w,h,sk);
  d=clarity(d,w,h,0.32);
  if(mode!=='portrait')d=textureBoost(d,w,h,0.28);

  prog(88,'Portrait Finishâ€¦');await tick();

  // Stage 9: Mode-specific
  if(mode==='portrait'&&faceR)d=portraitBlur(d,w,h,faceR);

  // Stage 10: Final polish
  d=vignette(d,w,h,0.2,0.78);

  prog(100,'Complete âœ“');await tick();
  return d;
}
function tick(){return new Promise(r=>setTimeout(r,0));}

/* â”€â”€â”€ NIGHT MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function nightMode(data,w,h,frames=8,boost=2.2){
  const n=w*h;
  const ar=new Float32Array(n),ag=new Float32Array(n),ab=new Float32Array(n);
  for(let f=0;f<frames;f++)for(let i=0;i<n;i++){const ns=()=>(Math.random()-.5)*14;ar[i]+=data[i*4]+ns();ag[i]+=data[i*4+1]+ns();ab[i]+=data[i*4+2]+ns();}
  const tmp=new Uint8ClampedArray(data.length);
  for(let i=0;i<n;i++){
    let r=ar[i]/frames*boost,g=ag[i]/frames*boost,b=ab[i]/frames*boost;
    const l=luma(r,g,b);if(l>205){const s=200/l*.85+.15;r*=s;g*=s;b*=s;}
    tmp[i*4]=clamp(r);tmp[i*4+1]=clamp(g);tmp[i*4+2]=clamp(b);tmp[i*4+3]=data[i*4+3];
  }
  return bilateral(tmp,w,h,5,24,4);
}

/* â”€â”€â”€ SIMPLE SYNC WRAPPERS (for pipelines that call sync) â”€â”€ */
function iphonePipeline(data,w,h){
  let d=autoWB(data,w,h);
  d=bilateral(d,w,h,4,22,3);
  d=shadowHL(d,w,h);
  d=smartSharpen(d,w,h,null);
  d=vibrance(d,w,h);
  d=acesToneMap(d,w,h,1.0);
  return d;
}
function cinemaPipeline(data,w,h){
  let d=bilateral(data,w,h,5,30,4);
  d=localTone(d,w,h,.5);
  d=hslAdjust(d,w,h);
  d=sCurve(d,w,h,1.2);
  d=acesToneMap(d,w,h,.96);
  d=vignette(d,w,h,.4);
  return d;
}
function portraitPipeline(data,w,h){
  const sk=skinMask(data,w,h);
  const faceR=estimateFace(sk,w,h);
  let d=autoWB(data,w,h);
  d=faceDenoise(d,w,h,sk);
  d=skinEnhance(d,w,h,sk);
  d=portraitBlur(d,w,h,faceR);
  d=vibrance(d,w,h,18,8,sk);
  d=smartSharpen(d,w,h,sk);
  return d;
}
function nightPipeline(data,w,h){
  let d=nightMode(data,w,h,8,2.4);
  d=waveletDenoise(d,w,h,22);
  d=clarity(d,w,h,.3);
  d=shadowHL(d,w,h,.35,.08);
  return d;
}
function proPipeline(data,w,h){
  const sk=skinMask(data,w,h);
  let d=lensCorrect(data,w,h);
  d=caFix(d,w,h);
  d=autoWB(d,w,h);
  d=waveletDenoise(d,w,h,14);
  d=adaptiveSharpen(d,w,h,1.5);
  d=hslAdjust(d,w,h);
  d=smartHDR(d,w,h);
  d=acesToneMap(d,w,h,1.0);
  return d;
}

// â•â• PIPELINE SELECTOR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PIPELINES={
  photo:    iphonePipeline,
  cine:     cinemaPipeline,
  portrait: portraitPipeline,
  night:    nightPipeline,
  slow:     iphonePipeline,
  astro:    astroPipeline,
  pro:      proPipeline,
  video:    d=>d,
};

// â•â• EDITOR ALGORITHM MAP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const EDITOR_ALGOS=[
  {id:'iphonePipelineAsync', name:'iPhone ISP Full',   desc:'ÙƒØ§Ù…Ù„ Ù…Ø¹Ø§Ù„Ø¬ Apple A17 (Ø£Ù‚ÙˆÙ‰)'},
  {id:'portraitPipeline',   name:'Portrait Mode',     desc:'ØµÙØ§Ø¡ ÙˆØ¬Ù‡ + Ø®Ù„ÙÙŠØ© Ø¶Ø¨Ø§Ø¨ÙŠØ©'},
  {id:'faceDenoise',        name:'Face Clarity âœ¨',   desc:'ØµÙØ§Ø¡ Ø§Ù„ÙˆØ¬Ù‡ â€” ÙŠØ²ÙŠÙ„ Ø§Ù„Ø­Ø¨ÙŠØ¨Ø§Øª'},
  {id:'skinEnhance',        name:'Skin Enhance',      desc:'ØªØ­Ø³ÙŠÙ† Ù„ÙˆÙ† Ø§Ù„Ø¨Ø´Ø±Ø©'},
  {id:'nokiaEnhance',       name:'Nokiaâ†’iPhone',      desc:'ØªØ±Ù‚ÙŠØ© Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¶Ø¹ÙŠÙØ©'},
  {id:'deepFusion',         name:'Deep Fusion',       desc:'Ø¯Ù…Ø¬ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø¥Ø·Ø§Ø±Ø§Øª (Apple)'},
  {id:'faceDenoise',        name:'Smart Denoise',     desc:'ØªÙ‚Ù„ÙŠÙ„ Ø¶ÙˆØ¶Ø§Ø¡ Ø°ÙƒÙŠ'},
  {id:'waveletDenoise',     name:'Wavelet',           desc:'ØªÙ‚Ù„ÙŠÙ„ Ø¶ÙˆØ¶Ø§Ø¡ Ù…ÙˆØ¬ÙŠ'},
  {id:'nlmFast',            name:'NLM Denoise',       desc:'Non-Local Means'},
  {id:'smartSharpen',       name:'Smart Sharpen âœ¨',  desc:'Ø­Ø¯Ø© Ø°ÙƒÙŠØ© â€” ØªØ­Ù…ÙŠ Ø§Ù„ÙˆØ¬Ù‡'},
  {id:'adaptiveSharpen',    name:'Adaptive Sharpen',  desc:'Ø­Ø¯Ø© Ù…ÙˆØ¬Ù‡Ø© Ø¨Ø§Ù„Ø­ÙˆØ§Ù'},
  {id:'clarity',            name:'Clarity',           desc:'ØªØ¨Ø§ÙŠÙ† Ù…Ø­Ù„ÙŠ (Definition)'},
  {id:'textureBoost',       name:'Texture',           desc:'ØªØ¹Ø²ÙŠØ² Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©'},
  {id:'smartHDR',           name:'Smart HDR',         desc:'Ø¯Ù…Ø¬ Ø§Ù„ØªØ¹Ø±ÙŠØ¶ (Apple)'},
  {id:'shadowHL',           name:'Shadow/HL',         desc:'Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¸Ù„Ø§Ù„ ÙˆØ§Ù„Ø¥Ø¶Ø§Ø¡Ø©'},
  {id:'localTone',          name:'Local Tone',        desc:'Dodge & Burn Ù…Ø­Ù„ÙŠ'},
  {id:'appleCurve',         name:'Apple Curve âœ¨',    desc:'Ù…Ù†Ø­Ù†Ù‰ Ø£Ù„ÙˆØ§Ù† iPhone Ø§Ù„Ø£ØµÙ„ÙŠ'},
  {id:'acesToneMap',        name:'ACES Cinema',       desc:'Tone map Ø³ÙŠÙ†Ù…Ø§Ø¦ÙŠ'},
  {id:'autoWB',             name:'Auto WB',           desc:'ØªÙˆØ§Ø²Ù† Ù„ÙˆÙ†ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ'},
  {id:'vibrance',           name:'Vibrance',          desc:'Ø£Ù„ÙˆØ§Ù† Ø°ÙƒÙŠØ© â€” ØªØ­Ù…ÙŠ Ø§Ù„Ø¨Ø´Ø±Ø©'},
  {id:'hslAdjust',          name:'HSL Selective',     desc:'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø¨Ø§Ù„Ù†Ø·Ø§Ù‚'},
  {id:'colorMatrix',        name:'Color Matrix',      desc:'Ù…Ø¹Ø§Ø¯Ù„Ø© Ù„ÙˆÙ† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§'},
  {id:'lensCorrect',        name:'Lens Correct',      desc:'ØªØµØ­ÙŠØ­ ØªØ´ÙˆÙŠÙ‡ Ø§Ù„Ø¹Ø¯Ø³Ø©'},
  {id:'caFix',              name:'CA Fix',            desc:'ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ù†ÙƒØ³Ø§Ø± Ø§Ù„Ù„ÙˆÙ†ÙŠ'},
  {id:'portraitBlur',       name:'Portrait Bokeh',    desc:'ØªÙ…ÙˆÙŠÙ‡ Ø§Ù„Ø®Ù„ÙÙŠØ©'},
  {id:'vignette',           name:'Vignette',          desc:'ØªØ¹ØªÙŠÙ… Ù†Ø§Ø¹Ù… Ù„Ù„Ø£Ø·Ø±Ø§Ù'},
  {id:'dehaze',             name:'Dehaze',            desc:'Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¶Ø¨Ø§Ø¨ Ø§Ù„Ø¬ÙˆÙŠ'},
  {id:'anisoDiff',          name:'Aniso Diffusion',   desc:'ØªÙ†Ø¹ÙŠÙ… Ù…Ø¹ Ø­ÙØ¸ Ø§Ù„Ø­ÙˆØ§Ù'},
  {id:'nightMode',          name:'Night Mode',        desc:'ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„'},
  {id:'filmGrain',          name:'Film Grain',        desc:'Ø­Ø¨ÙŠØ¨Ø§Øª Ø§Ù„ÙÙŠÙ„Ù…'},
  {id:'median',             name:'Median Filter',     desc:'Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¶ÙˆØ¶Ø§Ø¡ Ø§Ù„Ù†Ù‚Ø·ÙŠØ©'},
  {id:'hyperDetail',        name:'Hyper Detail',      desc:'ØªÙØ§ØµÙŠÙ„ ÙØ§Ø¦Ù‚Ø© Ø§Ù„Ø¯Ù‚Ø©'},
  {id:'sCurve',             name:'S-Curve',           desc:'ØªØ¨Ø§ÙŠÙ† ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ'},
  {id:'expFusion',          name:'HDR Fusion',        desc:'Ø¯Ù…Ø¬ Ø§Ù„ØªØ¹Ø±ÙŠØ¶'},
];

const ALGO_FNS={
  iphonePipelineAsync:(d,w,h)=>iphonePipelineAsync(d,w,h,{}),
  portraitPipeline,faceDenoise:(d,w,h)=>faceDenoise(d,w,h,skinMask(d,w,h)),
  skinEnhance:(d,w,h)=>skinEnhance(d,w,h,skinMask(d,w,h)),
  nokiaEnhance,deepFusion,waveletDenoise,nlmFast,
  smartSharpen:(d,w,h)=>smartSharpen(d,w,h,skinMask(d,w,h)),
  adaptiveSharpen,clarity,textureBoost,smartHDR,shadowHL,localTone,
  appleCurve,acesToneMap,autoWB,
  vibrance:(d,w,h)=>vibrance(d,w,h,45,8,skinMask(d,w,h)),
  hslAdjust,colorMatrix,lensCorrect,caFix,
  portraitBlur:(d,w,h)=>portraitBlur(d,w,h,estimateFace(skinMask(d,w,h),w,h)),
  vignette,dehaze,anisoDiff,nightMode,filmGrain,median,hyperDetail,sCurve,expFusion,
};

// â•â• CAPTURE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doShutter(){
  if(['video','cine','slow'].includes(S.mode)){
    S.recording?stopRec():startRec();
    return;
  }
  if(S.timer>0){runTimer();return;}
  capturePhoto();
}

async function capturePhoto(){
  haptic('heavy');
  flashO.classList.remove('go');void flashO.offsetWidth;flashO.classList.add('go');

  // Capture frame
  const vw=video.videoWidth||1920,vh=video.videoHeight||1080;
  capCvs.width=vw;capCvs.height=vh;
  const ctx=capCvs.getContext('2d');
  ctx.filter=video.style.filter||'';
  ctx.drawImage(video,0,0,vw,vh);
  let imgData=ctx.getImageData(0,0,vw,vh);

  if(S.settings.autoPipeline){
    showProc(true,'iPhone ISPâ€¦',3);
    try{
      // Use full async iPhone ISP (with face clarity, deep fusion, etc.)
      const processed=await iphonePipelineAsync(
        imgData.data,vw,vh,
        {mode:S.mode,iso:S.iso},
        (pct,step)=>showProc(true,step,pct)
      );
      imgData=new ImageData(processed,vw,vh);
    } catch(e){
      console.warn('ISP error, using sync fallback:',e);
      const pipeline=PIPELINES[S.mode]||iphonePipeline;
      try{const p=pipeline(imgData.data,vw,vh);imgData=new ImageData(p,vw,vh);}catch(e2){}
    }
  }

  ctx.filter='none';
  ctx.putImageData(imgData,0,0);
  const url=capCvs.toDataURL('image/jpeg',0.95);

  S.photos.push({url,lut:S.lut,iso:S.iso,ev:S.ev,mode:S.mode,ts:new Date().toLocaleTimeString(),w:vw,h:vh});
  updateGallery();
  $('h-shots').textContent=S.photos.length+' SHOTS';
  toast(`ğŸ“¸ ${vw}Ã—${vh} Â· ${LUTS_LIST.find(l=>l.id===S.lut)?.name||'Normal'} Â· ISO${S.iso}`);
  showProc(false);
}

function runTimer(){
  let n=S.timer;
  $('cd-n').textContent=n;
  $('cd-o').classList.add('show');
  haptic();
  const iv=setInterval(()=>{
    n--;$('cd-n').textContent=n;haptic();
    if(n<=0){clearInterval(iv);$('cd-o').classList.remove('show');capturePhoto();}
  },1000);
}

// â•â• RECORDING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startRec(){
  if(!S.stream||S.recording)return;
  S.chunks=[];
  const mimes=['video/webm;codecs=vp9,opus','video/webm;codecs=vp8,opus','video/webm','video/mp4'];
  let mime='';for(const m of mimes){if(MediaRecorder.isTypeSupported?.(m)){mime=m;break;}}
  try{S.recorder=mime?new MediaRecorder(S.stream,{mimeType:mime,videoBitsPerSecond:40_000_000}):new MediaRecorder(S.stream);}
  catch(e){toast('âŒ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…');return;}
  S.recorder.ondataavailable=e=>{if(e.data.size>0)S.chunks.push(e.data);};
  S.recorder.onstop=()=>{
    const blob=new Blob(S.chunks,{type:mime||'video/webm'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`cineframe_${Date.now()}.webm`;a.click();
    toast('ğŸ’¾ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø­ÙÙˆØ¸!');
  };
  S.recorder.start(100);S.recording=true;S.recStart=Date.now();
  shutter.classList.add('rec');
  S.recTicker=setInterval(()=>{ $('h-fps').innerHTML=`<span style="color:var(--red)">âº ${fmtMs(Date.now()-S.recStart)}</span>`; },1000);
  haptic('heavy');toast('ğŸ¬ ØªØ³Ø¬ÙŠÙ„â€¦');
}

function stopRec(){
  if(!S.recording||!S.recorder)return;
  S.recorder.stop();S.recording=false;
  shutter.classList.remove('rec');clearInterval(S.recTicker);
  $('h-fps').textContent='30 FPS';haptic('heavy');
}

// â•â• GALLERY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateGallery(){
  const g=$('gal-grid');
  if(!S.photos.length){g.innerHTML='<div class="gempty"><div class="ei">ğŸ“·</div>Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ø¨Ø¹Ø¯</div>';return;}
  g.innerHTML='';
  [...S.photos].reverse().forEach((p,i)=>{
    const ri=S.photos.length-1-i;
    const el=document.createElement('div');el.className='gi';
    el.innerHTML=`<img src="${p.url}" loading="lazy"><div class="gi-m">${p.lut||'Normal'} Â· ISO${p.iso}</div><div class="gi-del">âœ•</div>`;
    el.querySelector('img').onclick=()=>downloadPhoto(p);
    el.querySelector('.gi-del').onclick=(e)=>{e.stopPropagation();S.photos.splice(ri,1);updateGallery();};
    let pt;
    el.addEventListener('touchstart',()=>pt=setTimeout(()=>openEditor(p),600),{passive:true});
    el.addEventListener('touchend',()=>clearTimeout(pt),{passive:true});
    g.appendChild(el);
  });
}
function downloadPhoto(p){
  const a=document.createElement('a');a.href=p.url;a.download=`cineframe_${p.lut||'n'}_${Date.now()}.jpg`;a.click();toast('ğŸ’¾ ØªÙ… Ø§Ù„Ø­ÙØ¸!');
}

// â•â• EDITOR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildAlgoGrid(){
  const g=$('algo-grid');g.innerHTML='';
  EDITOR_ALGOS.forEach(a=>{
    const el=document.createElement('div');
    el.className='abtn'+(S.edAlgos.has(a.id)?' on':'');
    el.innerHTML=`<div class="abtn-n">${a.name}</div><div class="abtn-d">${a.desc}</div>`;
    el.onclick=()=>{
      S.edAlgos.has(a.id)?S.edAlgos.delete(a.id):S.edAlgos.add(a.id);
      el.classList.toggle('on',S.edAlgos.has(a.id));haptic();
    };
    g.appendChild(el);
  });
}

function openEditor(p){
  S.edPhoto=p;$('ed-img').src=p.url;
  $('editor-p').classList.add('open');buildAlgoGrid();
}

$('ed-apply').addEventListener('click',async()=>{
  if(!S.edPhoto||!S.edAlgos.size){toast('Ø§Ø®ØªØ± Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹');return;}
  const img=new Image();img.src=S.edPhoto.url;
  await new Promise(r=>img.onload=r);
  const c=document.createElement('canvas');c.width=img.width;c.height=img.height;
  const ctx=c.getContext('2d');ctx.drawImage(img,0,0);
  let d=ctx.getImageData(0,0,c.width,c.height);
  const algos=[...S.edAlgos];
  showProc(true,'Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©â€¦',0);
  for(let i=0;i<algos.length;i++){
    const fn=ALGO_FNS[algos[i]];
    const algoName=EDITOR_ALGOS.find(a=>a.id===algos[i])?.name||algos[i];
    showProc(true,algoName,Math.round((i/algos.length)*100));
    await new Promise(r=>setTimeout(r,0));
    if(fn){
      try{
        const r=await Promise.resolve(fn(d.data,d.width,d.height));
        if(r instanceof Uint8ClampedArray)d=new ImageData(r,d.width,d.height);
      }catch(e){console.warn('Algo error:',algos[i],e);}
    }
  }
  c.width=d.width;c.height=d.height;
  ctx.putImageData(d,0,0);
  const url=c.toDataURL('image/jpeg',0.96);
  $('ed-img').src=url;
  const idx=S.photos.findIndex(p=>p.url===S.edPhoto.url);
  if(idx>=0){S.photos[idx].url=url;updateGallery();}
  showProc(false);toast('âœ… ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª!');
});

$('ed-dl').addEventListener('click',()=>{
  if(S.edPhoto)downloadPhoto({url:$('ed-img').src,lut:'edited'});
});

// â•â• LUT STRIP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildLUTStrip(){
  const strip=$('lut-strip');strip.innerHTML='';
  LUTS_LIST.forEach(lut=>{
    const el=document.createElement('div');
    el.className='lfi'+(S.lut===lut.id?' on':'');
    const cvs=document.createElement('canvas');cvs.width=48;cvs.height=48;
    drawLUTThumb(cvs.getContext('2d'),lut.id);
    el.innerHTML=`<div class="lfi-sw"></div><div class="lfi-nm">${lut.name}</div>`;
    el.querySelector('.lfi-sw').appendChild(cvs);
    el.onclick=()=>{
      S.lut=lut.id;QA('.lfi').forEach(f=>f.classList.remove('on'));
      el.classList.add('on');applyVideoStyle();
      $('h-lut').textContent=lut.name;
      $('h-algo').textContent='LUT: '+lut.name;
      toast('LUT: '+lut.name);haptic();
    };
    strip.appendChild(el);
  });
}

function drawLUTThumb(ctx,lutId){
  const w=48,h=48;
  const g=ctx.createLinearGradient(0,0,w,h);
  // Sample LUT colors
  const css=LUT_CSS[lutId]||'';
  // Draw approximation
  const colors=['#c84444','#3c78c8','#4cc850','#c8b43c','#7844c8','#c87844'];
  colors.forEach((c,i)=>{g.addColorStop(i/5,c);});
  ctx.fillStyle=g;ctx.fillRect(0,0,w,h);
  // Apply simulated effect
  if(lutId==='noir'){const d=ctx.getImageData(0,0,w,h);for(let i=0;i<d.data.length;i+=4){const v=(d.data[i]*.3+d.data[i+1]*.59+d.data[i+2]*.11)|0;d.data[i]=d.data[i+1]=d.data[i+2]=v;}ctx.putImageData(d,0,0);}
  ctx.fillStyle='rgba(0,0,0,.25)';ctx.fillRect(0,h*.6,w,h*.4);
  ctx.fillStyle='rgba(255,255,255,.3)';ctx.font='5px monospace';ctx.fillText(lutId.substring(0,7),3,h-5);
}

// â•â• HISTOGRAM + LOOPS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let histRAF, faceFrame=0;
const tmpC=document.createElement('canvas');tmpC.width=64;tmpC.height=48;
const tmpCtx=tmpC.getContext('2d');

function startLoops(){
  cancelAnimationFrame(histRAF);
  function loop(){drawHist();drawWave();faceFrame++;if(faceFrame%50===0)detectFaceHUD();histRAF=requestAnimationFrame(loop);}
  loop();
}

// Face detection from live video (lightweight â€” uses YCbCr sampling)
function detectFaceHUD(){
  if(!S.camReady||video.readyState<2||video.videoWidth===0)return;
  try{
    tmpCtx.drawImage(video,0,0,64,48);
    const px=tmpCtx.getImageData(0,0,64,48).data;
    let skinCnt=0,cxSum=0,cySum=0;
    for(let y=0;y<48;y++)for(let x=0;x<64;x++){
      const i=(y*64+x)*4,r=px[i],g=px[i+1],b=px[i+2];
      const Y=0.299*r+0.587*g+0.114*b;
      const Cb=-0.169*r-0.331*g+0.5*b+128;
      const Cr=0.5*r-0.419*g-0.081*b+128;
      if(Cb>=77&&Cb<=127&&Cr>=133&&Cr<=173&&Y>40&&Y<230){skinCnt++;cxSum+=x;cySum+=y;}
    }
    const hasFace=skinCnt>60;
    $('h-face').textContent=hasFace?`Face âœ“`:'Face: â€”';
    $('h-face').style.color=hasFace?'var(--grn)':'var(--mu1)';
    $('h-face').style.borderColor=hasFace?'rgba(0,230,118,.3)':'rgba(255,255,255,.07)';
    // Show face ring
    if(hasFace){
      const vr=video.getBoundingClientRect();
      const fx=(cxSum/skinCnt/64)*vr.width+vr.left;
      const fy=(cySum/skinCnt/48)*vr.height+vr.top;
      const fr=$('fring');fr.style.left=fx+'px';fr.style.top=fy+'px';
      if(!fr.className.includes('show')&&!fr.className.includes('lock')){fr.className='show';}
    }
  }catch(e){}
}

function drawHist(){
  if(!S.settings.histogram){histCtx.clearRect(0,0,86,34);return;}
  const w=86,h=34;
  let R,G,B;
  if(S.camReady&&video.readyState>=2&&video.videoWidth>0){
    try{
      tmpCtx.drawImage(video,0,0,64,48);
      const px=tmpCtx.getImageData(0,0,64,48).data;
      R=new Uint32Array(256);G=new Uint32Array(256);B=new Uint32Array(256);
      for(let i=0;i<px.length;i+=4){R[px[i]]++;G[px[i+1]]++;B[px[i+2]]++;}
    }catch(e){R=G=B=null;}
  }
  if(!R){
    const c=128+S.ev*22,sp=44+S.iso/200;
    R=new Uint32Array(256);G=new Uint32Array(256);B=new Uint32Array(256);
    for(let i=0;i<256;i++){
      R[i]=Math.max(0,Math.round(270*Math.exp(-((i-c-4)**2)/(2*sp**2))+Math.random()*10));
      G[i]=Math.max(0,Math.round(290*Math.exp(-((i-c)**2)/(2*sp**2))+Math.random()*10));
      B[i]=Math.max(0,Math.round(255*Math.exp(-((i-c+4)**2)/(2*sp**2))+Math.random()*10));
    }
  }
  histCtx.clearRect(0,0,w,h);
  histCtx.fillStyle='rgba(0,0,0,.7)';histCtx.fillRect(0,0,w,h);
  const mx=Math.max(...R,...G,...B)||1;
  [[R,'rgba(255,55,55,.65)'],[G,'rgba(55,215,55,.5)'],[B,'rgba(55,120,255,.6)']].forEach(([d,col])=>{
    histCtx.beginPath();histCtx.moveTo(0,h);
    for(let i=0;i<256;i++)histCtx.lineTo(i/255*w,h-d[i]/mx*(h-2));
    histCtx.lineTo(w,h);histCtx.closePath();histCtx.fillStyle=col;histCtx.fill();
  });
  histCtx.fillStyle='rgba(255,255,255,.15)';histCtx.fillRect(0,0,1,h);histCtx.fillRect(w-1,0,1,h);
}

function drawWave(){
  const w=56,h=26;
  waveCtx.clearRect(0,0,w,h);
  waveCtx.fillStyle='rgba(0,0,0,.6)';waveCtx.fillRect(0,0,w,h);
  waveCtx.strokeStyle='rgba(0,229,255,.55)';waveCtx.lineWidth=1;
  waveCtx.beginPath();
  for(let x=0;x<w;x++){
    const y=h/2+Math.sin(Date.now()*.003+x*.42)*(h*.28*(0.6+Math.random()*.4));
    x===0?waveCtx.moveTo(x,y):waveCtx.lineTo(x,y);
  }
  waveCtx.stroke();
}

// â•â• GRID â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawGrid(){
  const vf=$('vf');
  gridCvs.width=vf.offsetWidth;gridCvs.height=vf.offsetHeight;
  const w=gridCvs.width,h=gridCvs.height;
  gridCtx.clearRect(0,0,w,h);
  const type=$('grid-type')?.value||'Rule of Thirds';
  gridCtx.strokeStyle='rgba(255,255,255,.2)';gridCtx.lineWidth=.5;
  if(type==='Phi Grid'){
    [.618,1-.618].forEach(t=>{
      gridCtx.beginPath();gridCtx.moveTo(t*w,0);gridCtx.lineTo(t*w,h);gridCtx.stroke();
      gridCtx.beginPath();gridCtx.moveTo(0,t*h);gridCtx.lineTo(w,t*h);gridCtx.stroke();
    });
  }else if(type==='Diagonal'){
    gridCtx.beginPath();gridCtx.moveTo(0,0);gridCtx.lineTo(w,h);gridCtx.stroke();
    gridCtx.beginPath();gridCtx.moveTo(w,0);gridCtx.lineTo(0,h);gridCtx.stroke();
  }else{
    [1/3,2/3].forEach(t=>{
      gridCtx.beginPath();gridCtx.moveTo(t*w,0);gridCtx.lineTo(t*w,h);gridCtx.stroke();
      gridCtx.beginPath();gridCtx.moveTo(0,t*h);gridCtx.lineTo(w,t*h);gridCtx.stroke();
    });
  }
  gridCtx.strokeStyle='rgba(255,255,255,.45)';gridCtx.lineWidth=.8;
  const bs=18;
  [[0,0],[w,0],[0,h],[w,h]].forEach(([cx,cy])=>{
    const sx=cx===0?1:-1,sy=cy===0?1:-1;
    gridCtx.beginPath();gridCtx.moveTo(cx,cy+sy*bs);gridCtx.lineTo(cx,cy);gridCtx.lineTo(cx+sx*bs,cy);gridCtx.stroke();
  });
  gridCtx.strokeStyle='rgba(255,255,255,.35)';
  gridCtx.beginPath();gridCtx.moveTo(w/2-7,h/2);gridCtx.lineTo(w/2+7,h/2);gridCtx.stroke();
  gridCtx.beginPath();gridCtx.moveTo(w/2,h/2-7);gridCtx.lineTo(w/2,h/2+7);gridCtx.stroke();
}

// â•â• TOUCH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lastTap=0,pinchD=0,swipeY=0;
$('vf').addEventListener('click',e=>{
  const now=Date.now();
  if(now-lastTap<280){S.zoom=S.zoom===1?2:1;setZoom(S.zoom);toast(S.zoom+'Ã— Zoom');}
  else setFocus(e.clientX,e.clientY);
  lastTap=now;haptic();
});
$('vf').addEventListener('touchstart',e=>{
  if(e.touches.length===2)pinchD=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
  swipeY=e.touches[0].clientY;
},{passive:true});
$('vf').addEventListener('touchmove',e=>{
  if(e.touches.length===2){
    e.preventDefault();
    const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
    S.zoom=Math.min(10,Math.max(1,S.zoom+(d-pinchD)*.018));pinchD=d;setZoom(S.zoom);
  }
},{passive:false});
$('vf').addEventListener('touchend',e=>{
  if(e.changedTouches[0].clientY-swipeY<-70)$('gallery-p').classList.add('open');
},{passive:true});

// â•â• SLIDERS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
$('sl-ev').addEventListener('input',function(){
  S.ev=parseFloat(this.value);
  $('ev-v').textContent=(S.ev>=0?'+':'')+S.ev.toFixed(1);
  applyVideoStyle();
});
$('sl-iso').addEventListener('input',function(){
  S.iso=ISO_STEPS[+this.value];
  $('iso-v').textContent=S.iso;$('h-iso').textContent='ISO '+S.iso;
  updateSS();applyVideoStyle();
});
$('sl-wb').addEventListener('input',function(){
  S.wb=+this.value;
  $('wb-v').textContent=S.wb;$('h-wb').textContent=S.wb+'K';
  applyVideoStyle();
});
$('sl-sh').addEventListener('input',function(){
  S.sharp=parseFloat(this.value);
  $('sh-v').textContent=(S.sharp>=0?'+':'')+S.sharp.toFixed(1);
  applyVideoStyle();
});

// â•â• BUTTONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
$('shutter').addEventListener('click',()=>doShutter());
$('btn-grid').addEventListener('click',()=>{
  gridCvs.classList.toggle('on');$('btn-grid').classList.toggle('on',gridCvs.classList.contains('on'));
  if(gridCvs.classList.contains('on'))drawGrid();haptic();
});
$('btn-hist').addEventListener('click',()=>{
  S.settings.histogram=!S.settings.histogram;$('btn-hist').classList.toggle('on',S.settings.histogram);haptic();
});
$('btn-flip').addEventListener('click',()=>{flipCam();haptic();});
$('btn-editor').addEventListener('click',()=>{
  if(S.photos.length)openEditor(S.photos[S.photos.length-1]);
  else toast('Ø®Ø° ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„ØªØ­Ø±ÙŠØ±');
});
$('btn-settings').addEventListener('click',()=>{$('settings-p').classList.add('open');haptic();});
$('cls-s').addEventListener('click',()=>{$('settings-p').classList.remove('open');haptic();});
$('btn-gallery').addEventListener('click',()=>{$('gallery-p').classList.add('open');haptic();});
$('cls-g').addEventListener('click',()=>{$('gallery-p').classList.remove('open');haptic();});
$('cls-e').addEventListener('click',()=>{$('editor-p').classList.remove('open');haptic();});
$('btn-pip').addEventListener('click',()=>{
  S.settings.autoPipeline=!S.settings.autoPipeline;
  $('btn-pip').classList.toggle('on',S.settings.autoPipeline);
  $('h-algo').textContent='Pipeline: '+(S.settings.autoPipeline?'ON':'OFF');
  toast('Pipeline: '+(S.settings.autoPipeline?'ØªØ´ØºÙŠÙ„ âœ“':'Ø¥ÙŠÙ‚Ø§Ù'));haptic();
});

// Flash
const FI={off:'âš¡',on:'ğŸ’¡',auto:'âœ¨'};
$('btn-flash').addEventListener('click',()=>{
  const s=['off','on','auto'],i=s.indexOf(S.flash);S.flash=s[(i+1)%3];
  $('btn-flash').textContent=FI[S.flash];$('btn-flash').classList.toggle('on',S.flash!=='off');
  if(S.stream){const t=S.stream.getVideoTracks()[0];if(t)t.applyConstraints({advanced:[{torch:S.flash==='on'}]}).catch(()=>{});}
  toast('Flash: '+S.flash.toUpperCase());haptic();
});

// Timer
$('btn-timer').addEventListener('click',()=>{
  const o=[0,3,10],i=o.indexOf(S.timer);S.timer=o[(i+1)%3];
  $('btn-timer').textContent=S.timer===0?'â±':'â±'+S.timer;
  $('btn-timer').classList.toggle('on',S.timer>0);
  toast(S.timer===0?'Timer off':'Timer: '+S.timer+'s');haptic();
});

// Zoom buttons
QA('.zo').forEach(b=>b.addEventListener('click',()=>{
  S.zoom=parseFloat(b.dataset.z);setZoom(S.zoom);
  QA('.zo').forEach(z=>z.classList.toggle('on',parseFloat(z.dataset.z)===S.zoom));haptic();
}));

// Mode strip
QA('.md').forEach(btn=>btn.addEventListener('click',()=>{
  QA('.md').forEach(b=>b.classList.remove('on'));btn.classList.add('on');
  S.mode=btn.dataset.mode;$('h-mode').textContent=btn.textContent;
  const isVid=['video','cine','slow','astro'].includes(S.mode);
  shutter.style.background=isVid?'var(--red)':'var(--wh)';
  if(S.mode==='cine'){cbT.classList.add('on');cbB.classList.add('on');}
  else{cbT.classList.remove('on');cbB.classList.remove('on');}
  $('h-fps').textContent=S.mode==='slow'?'240 FPS':S.mode==='cine'?'24 FPS':'30 FPS';
  if(S.recording)stopRec();toast('Mode: '+btn.textContent);haptic();
}));

// Settings toggles
QA('.tog[data-k]').forEach(t=>{
  const k=t.dataset.k;
  const val=k.startsWith('lock')?S.featureLocks[k]:S.settings[k];
  if(val)t.classList.add('on');
  t.addEventListener('click',()=>{
    if(k.startsWith('lock')){
      S.featureLocks[k]=!S.featureLocks[k];
      t.classList.toggle('on',S.featureLocks[k]);
      localStorage.setItem('cf_'+k.replace('lock','').toLowerCase(),S.featureLocks[k]);
    } else {
      S.settings[k]=!S.settings[k];
      t.classList.toggle('on',S.settings[k]);
      if(k==='pinOnOpen')localStorage.setItem('cf_pin_on',S.settings[k]);
      if(k==='cinebars'){cbT.classList.toggle('on',S.settings[k]);cbB.classList.toggle('on',S.settings[k]);}
    }
    applyFeatureLocks();haptic();
  });
});

// Grid type
$('grid-type')?.addEventListener('change',()=>{if(gridCvs.classList.contains('on'))drawGrid();});
$('asp-sel')?.addEventListener('change',function(){$('h-res').textContent='4K Â· '+this.value;});

// Keyboard
document.addEventListener('keydown',e=>{
  if(e.target.tagName==='SELECT'||e.target.tagName==='INPUT')return;
  if(e.code==='Space'){e.preventDefault();doShutter();}
  if(e.code==='KeyG')$('btn-grid').click();
  if(e.code==='KeyF')$('btn-flip').click();
  if(e.key==='+')setZoom(Math.min(10,S.zoom+.5));
  if(e.key==='-')setZoom(Math.max(1,S.zoom-.5));
});

// Visibility
document.addEventListener('visibilitychange',()=>{if(document.hidden&&S.recording)stopRec();});
window.addEventListener('resize',()=>{if(gridCvs.classList.contains('on'))drawGrid();});

// â•â• PWA â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();S.deferredInstall=e;$('install-bar').classList.add('show');
});
$('do-install').addEventListener('click',()=>{
  if(!S.deferredInstall)return;
  S.deferredInstall.prompt();
  S.deferredInstall.userChoice.then(()=>{$('install-bar').classList.remove('show');S.deferredInstall=null;toast('âœ… ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª!');});
});
if('serviceWorker' in navigator)navigator.serviceWorker.register('./sw.js').catch(console.warn);

// â•â• BOOT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async function boot(){
  setupPinGrid();
  initLockScreen();
  updateSS();
  buildLUTStrip();
  buildAlgoGrid();

  // Start camera after splash
  setTimeout(async()=>{
    await startCamera();
    $('app').classList.add('alive');
    $('splash').classList.add('out');
    setTimeout(()=>$('splash').style.display='none',700);
  },2400);
})();
</script>
</body>
</html>
