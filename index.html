<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0a0a0a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CineFrame">
<meta name="description" content="CineFrame Pro - ØªØ·Ø¨ÙŠÙ‚ ÙƒØ§Ù…ÙŠØ±Ø§ Ø³ÙŠÙ†Ù…Ø§Ø¦ÙŠ Ø§Ø­ØªØ±Ø§ÙÙŠ">
<link rel="manifest" href="./manifest.json">
<link rel="apple-touch-icon" href="./icon-192.png">
<title>CineFrame Pro</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Space+Mono:wght@400;700&family=Noto+Kufi+Arabic:wght@300;400;700&display=swap');

:root {
  --black:   #0a0a0a;
  --dark:    #111;
  --panel:   #1a1a1a;
  --border:  #2a2a2a;
  --accent:  #ff4400;
  --accent2: #ffaa00;
  --gold:    #c8a94a;
  --white:   #f0ede8;
  --muted:   #555;
  --green:   #00ff88;
  --red:     #ff2244;
  --blue:    #0088ff;
}

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}

html,body{
  width:100%;height:100%;
  background:var(--black);
  color:var(--white);
  font-family:'Space Mono',monospace;
  overflow:hidden;
  user-select:none;
}

/* â”€â”€ SPLASH â”€â”€ */
#splash{
  position:fixed;inset:0;z-index:9999;
  background:var(--black);
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:16px;
}
.splash-logo{
  font-family:'Bebas Neue',sans-serif;
  font-size:clamp(52px,14vw,88px);
  letter-spacing:8px;color:var(--white);line-height:1;
  animation:up .8s cubic-bezier(.16,1,.3,1) .2s both;
}
.splash-logo span{color:var(--accent)}
.splash-sub{font-size:10px;letter-spacing:5px;color:var(--muted);text-transform:uppercase;animation:up .8s .4s both}
.splash-bar{width:180px;height:1px;background:var(--border);overflow:hidden;animation:up 0s .6s both;position:relative}
.splash-bar::after{content:'';position:absolute;top:0;left:-100%;height:100%;width:100%;
  background:linear-gradient(90deg,transparent,var(--accent),transparent);
  animation:bar 1.6s ease .7s forwards}
@keyframes up{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:none}}
@keyframes bar{to{left:100%}}

/* â”€â”€ APP â”€â”€ */
#app{
  width:100%;height:100%;
  display:flex;flex-direction:column;
  opacity:0;
  transition:opacity .6s ease;
}
#app.ready{opacity:1}

/* â”€â”€ ERROR SCREEN â”€â”€ */
#error-screen{
  position:fixed;inset:0;z-index:200;
  background:var(--black);
  display:none;flex-direction:column;
  align-items:center;justify-content:center;
  gap:20px;padding:40px;text-align:center;
}
#error-screen.show{display:flex}
.error-icon{font-size:60px}
.error-title{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:4px;color:var(--accent)}
.error-msg{font-size:12px;color:var(--muted);line-height:1.8;letter-spacing:.5px}
.error-btn{
  padding:12px 28px;
  background:var(--accent);color:var(--white);
  border:none;border-radius:8px;
  font-family:'Space Mono',monospace;font-size:12px;letter-spacing:2px;
  cursor:pointer;text-transform:uppercase;
}

/* â”€â”€ TOP BAR â”€â”€ */
#topbar{
  background:var(--dark);border-bottom:1px solid var(--border);
  padding:10px 14px;
  display:flex;align-items:center;justify-content:space-between;
  flex-shrink:0;z-index:50;
}
.brand{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:4px}
.brand span{color:var(--accent)}
.top-btns{display:flex;gap:6px}
.top-btn{
  width:36px;height:36px;border-radius:6px;
  border:1px solid var(--border);background:var(--panel);
  color:var(--white);display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:all .15s;font-size:15px;
}
.top-btn:active{transform:scale(.88)}
.top-btn.on{border-color:var(--accent);color:var(--accent);background:rgba(255,68,0,.1)}

/* â”€â”€ MODE STRIP â”€â”€ */
#modes{
  background:var(--dark);border-bottom:1px solid var(--border);
  display:flex;overflow-x:auto;scrollbar-width:none;flex-shrink:0;padding:0 6px;
}
#modes::-webkit-scrollbar{display:none}
.mode{
  flex-shrink:0;padding:10px 14px;
  font-size:9px;letter-spacing:2px;text-transform:uppercase;
  color:var(--muted);cursor:pointer;
  border-bottom:2px solid transparent;transition:all .2s;white-space:nowrap;
}
.mode.on{color:var(--accent);border-bottom-color:var(--accent)}

/* â”€â”€ VIEWFINDER â”€â”€ */
#vf{
  position:relative;flex:1;overflow:hidden;background:#000;
  /* Ensure video fills correctly */
}
#video{
  position:absolute;inset:0;
  width:100%;height:100%;
  object-fit:cover;display:block;
  transform-origin:center;
  transition:filter .2s;
}
/* Cinematic bars */
.cbar{position:absolute;left:0;right:0;background:#000;z-index:10;transition:height .4s}
#cbar-t{top:0;height:0}
#cbar-b{bottom:0;height:0}
#cbar-t.on,#cbar-b.on{height:12%}
/* Grid */
#grid{position:absolute;inset:0;z-index:9;pointer-events:none;opacity:0;transition:opacity .3s}
#grid.on{opacity:1}
#grid svg{width:100%;height:100%}
/* Focus ring */
#fring{
  position:absolute;width:72px;height:72px;
  border:1.5px solid var(--accent2);z-index:15;pointer-events:none;
  opacity:0;transform:translate(-50%,-50%) scale(1.4);transition:all .2s;
}
#fring::before,#fring::after{content:'';position:absolute;background:var(--accent2)}
#fring::before{top:50%;left:-6px;right:-6px;height:1px}
#fring::after{left:50%;top:-6px;bottom:-6px;width:1px}
#fring.show{opacity:1;transform:translate(-50%,-50%) scale(1)}
#fring.lock{border-color:var(--green);animation:fp 1.5s ease infinite}
@keyframes fp{50%{opacity:.4}}

/* â”€â”€ HUD â”€â”€ */
#hud{
  position:absolute;inset:0;z-index:20;pointer-events:none;
  padding:14px;display:flex;flex-direction:column;justify-content:space-between;
}
.hud-r{display:flex;justify-content:space-between;align-items:flex-start}
.hud-b{display:flex;justify-content:space-between;align-items:flex-end}
.chip{
  background:rgba(0,0,0,.6);backdrop-filter:blur(8px);
  border:1px solid rgba(255,255,255,.08);border-radius:4px;
  padding:4px 9px;font-size:9px;letter-spacing:1px;color:var(--white);
  line-height:1.6;margin-bottom:5px;display:block;
}
.chip.ac{border-color:var(--accent);color:var(--accent)}
.chip.gn{color:var(--green);border-color:rgba(0,255,136,.3)}
.chip.go{color:var(--gold);border-color:rgba(200,169,74,.3)}
.chip.rd{color:var(--red);border-color:rgba(255,34,68,.3)}

#rec-dot{display:inline-block;width:6px;height:6px;border-radius:50%;
  background:var(--red);margin-left:4px;vertical-align:middle;
  box-shadow:0 0 6px var(--red);animation:rb 1s ease infinite}
@keyframes rb{50%{opacity:.1}}

/* Histogram */
#hist-canvas{width:96px;height:38px;display:block}

/* â”€â”€ BOTTOM PANEL â”€â”€ */
#bottom{
  background:var(--dark);border-top:1px solid var(--border);
  padding:10px 14px 18px;flex-shrink:0;
}

/* Filter strip */
#filters{
  display:flex;gap:7px;overflow-x:auto;scrollbar-width:none;
  padding-bottom:10px;margin-bottom:10px;
}
#filters::-webkit-scrollbar{display:none}
.fi{flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer}
.fi-thumb{
  width:48px;height:48px;border-radius:8px;
  border:2px solid var(--border);overflow:hidden;transition:border-color .2s;
}
.fi.on .fi-thumb{border-color:var(--accent)}
.fi-name{font-size:7px;letter-spacing:1px;color:var(--muted);text-transform:uppercase}
.fi.on .fi-name{color:var(--accent)}
.fi canvas{width:100%;height:100%;display:block}

/* Sliders */
.sliders{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:14px}
.sg{display:flex;flex-direction:column;gap:4px}
.sl-lbl{display:flex;justify-content:space-between;font-size:8px;letter-spacing:1px;color:var(--muted);text-transform:uppercase}
.sl-lbl b{color:var(--white);font-weight:700}
input[type=range]{
  -webkit-appearance:none;width:100%;height:3px;border-radius:2px;
  background:var(--border);outline:none;cursor:pointer;
}
input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none;width:14px;height:14px;border-radius:50%;
  background:var(--accent);border:2px solid var(--dark);
  box-shadow:0 0 6px rgba(255,68,0,.5);cursor:pointer;transition:transform .1s;
}
input[type=range]::-webkit-slider-thumb:active{transform:scale(1.3)}
input.iso::-webkit-slider-thumb{background:var(--accent2);box-shadow:0 0 6px rgba(255,170,0,.5)}
input.wb::-webkit-slider-thumb{background:var(--blue);box-shadow:0 0 6px rgba(0,136,255,.5)}

/* Shutter row */
.sh-row{display:flex;align-items:center;justify-content:space-between;gap:10px}
.ctrls{display:flex;gap:7px;align-items:center}
.cbtn{
  width:44px;height:44px;border-radius:10px;
  border:1px solid var(--border);background:var(--panel);
  color:var(--white);display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:all .15s;font-size:16px;flex-shrink:0;
}
.cbtn:active{transform:scale(.88)}
.cbtn.on{border-color:var(--accent);color:var(--accent)}

/* Shutter button */
#shutter{
  width:72px;height:72px;border-radius:50%;
  background:var(--white);flex-shrink:0;
  border:4px solid rgba(255,255,255,.15);
  box-shadow:0 0 0 2px var(--border),0 4px 20px rgba(0,0,0,.5);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all .12s;position:relative;
}
#shutter:active{transform:scale(.9)}
#shutter.rec{background:var(--red);animation:recr 2s ease infinite}
@keyframes recr{50%{box-shadow:0 0 0 10px rgba(255,34,68,.15),0 4px 20px rgba(0,0,0,.5)}}
#shutter-inner{width:22px;height:22px;border-radius:4px;background:var(--black);transition:all .2s}
#shutter.rec #shutter-inner{border-radius:3px;background:#fff}

/* Zoom pill */
.zpill{
  background:var(--panel);border:1px solid var(--border);
  border-radius:20px;padding:5px 4px;display:flex;flex-direction:column;gap:1px;
}
.zo{
  font-size:9px;font-family:'Space Mono',monospace;font-weight:700;
  color:var(--muted);padding:4px 7px;border-radius:14px;cursor:pointer;
  transition:all .15s;text-align:center;
}
.zo.on{background:var(--accent);color:#fff}

/* â”€â”€ PANELS â”€â”€ */
.panel{
  position:absolute;inset:0;background:var(--black);z-index:100;
  overflow-y:auto;padding:20px;
  transition:transform .35s cubic-bezier(.16,1,.3,1);
}
#settings-p{transform:translateX(100%)}
#settings-p.open{transform:none}
#gallery-p{transform:translateY(100%)}
#gallery-p.open{transform:none}
.p-title{
  font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:4px;
  margin-bottom:22px;display:flex;align-items:center;justify-content:space-between;
}
.close-btn{
  width:34px;height:34px;border-radius:50%;background:var(--panel);
  border:1px solid var(--border);color:var(--white);
  display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;
}
.close-btn:active{transform:scale(.9)}
.sec-lbl{
  font-size:8px;letter-spacing:3px;color:var(--accent);text-transform:uppercase;
  margin-bottom:10px;padding-bottom:5px;border-bottom:1px solid var(--border);margin-top:20px;
}
.s-row{
  display:flex;justify-content:space-between;align-items:center;
  padding:11px 0;border-bottom:1px solid rgba(255,255,255,.04);
}
.s-lbl{font-size:11px;color:var(--white)}
.s-desc{font-size:9px;color:var(--muted);margin-top:2px}
.toggle{
  width:42px;height:22px;background:var(--border);border-radius:11px;
  position:relative;cursor:pointer;transition:background .2s;flex-shrink:0;
}
.toggle.on{background:var(--accent)}
.toggle::after{
  content:'';position:absolute;width:16px;height:16px;background:#fff;
  border-radius:50%;top:3px;left:3px;transition:transform .2s;
}
.toggle.on::after{transform:translateX(20px)}
.s-sel{
  background:var(--panel);border:1px solid var(--border);color:var(--white);
  border-radius:6px;padding:5px 8px;font-family:'Space Mono',monospace;
  font-size:10px;outline:none;cursor:pointer;
}

/* Gallery */
#gal-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:3px}
.g-item{
  aspect-ratio:1;background:var(--panel);border-radius:2px;
  overflow:hidden;position:relative;cursor:pointer;
}
.g-item img{width:100%;height:100%;object-fit:cover;display:block}
.g-meta{
  position:absolute;bottom:0;left:0;right:0;padding:5px;
  background:linear-gradient(transparent,rgba(0,0,0,.8));
  font-size:7px;color:rgba(255,255,255,.6);
}
.g-empty{
  grid-column:1/-1;text-align:center;padding:60px 20px;
  color:var(--muted);font-size:11px;letter-spacing:1px;
}
.g-empty .ei{font-size:44px;margin-bottom:12px;opacity:.25}

/* â”€â”€ OVERLAYS â”€â”€ */
#flash-overlay{
  position:fixed;inset:0;background:#fff;z-index:300;
  opacity:0;pointer-events:none;
}
#flash-overlay.flash{animation:fl .3s ease}
@keyframes fl{0%{opacity:.9}100%{opacity:0}}

#toast{
  position:fixed;bottom:130px;left:50%;
  transform:translateX(-50%) translateY(16px);
  background:rgba(0,0,0,.85);backdrop-filter:blur(10px);
  border:1px solid var(--border);border-radius:20px;
  padding:7px 18px;font-size:10px;letter-spacing:1px;color:var(--white);
  z-index:400;opacity:0;pointer-events:none;transition:all .22s ease;
}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* Timer countdown */
#countdown{
  position:fixed;inset:0;z-index:250;display:none;
  align-items:center;justify-content:center;
  background:rgba(0,0,0,.4);
}
#countdown.show{display:flex}
#countdown-num{
  font-family:'Bebas Neue',sans-serif;font-size:140px;
  color:var(--white);text-shadow:0 0 40px rgba(255,68,0,.8);
  animation:cdblink .9s ease infinite;
}
@keyframes cdblink{50%{opacity:.3}}

/* noise */
body::after{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:500;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  opacity:.35;
}

/* install prompt */
#install-btn{
  position:fixed;bottom:0;left:0;right:0;z-index:600;
  padding:14px 20px;background:var(--dark);
  border-top:1px solid var(--border);
  display:none;align-items:center;justify-content:space-between;gap:12px;
}
#install-btn.show{display:flex}
.install-txt{font-size:11px;color:var(--white);letter-spacing:.5px}
.install-txt small{display:block;color:var(--muted);font-size:9px;margin-top:2px}
.i-btn{
  padding:8px 16px;background:var(--accent);color:#fff;border:none;
  border-radius:8px;font-family:'Space Mono',monospace;font-size:10px;
  letter-spacing:1px;cursor:pointer;white-space:nowrap;
}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <div class="splash-logo">CINE<span>FRAME</span></div>
  <div class="splash-sub">Cinema Camera Pro Â· v2.0</div>
  <div class="splash-bar"></div>
</div>

<!-- ERROR SCREEN -->
<div id="error-screen">
  <div class="error-icon">ğŸ“·</div>
  <div class="error-title">ØªØ­ØªØ§Ø¬ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</div>
  <div class="error-msg">
    Ø§Ø³Ù…Ø­ Ù„Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§<br>
    Ø«Ù… Ø§Ø¶ØºØ· "Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§"<br><br>
    <small style="color:#333">Chrome â†’ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø«Ù„Ø§Ø« â†’ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ â†’ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ â†’ Ø³Ù…Ø§Ø­</small>
  </div>
  <button class="error-btn" onclick="retryCamera()">ğŸ”„ Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§</button>
</div>

<!-- FLASH -->
<div id="flash-overlay"></div>

<!-- COUNTDOWN -->
<div id="countdown"><div id="countdown-num">3</div></div>

<!-- TOAST -->
<div id="toast"></div>

<!-- INSTALL PROMPT -->
<div id="install-btn">
  <div class="install-txt">
    Ø«Ø¨Ù‘Øª CineFrame Pro
    <small>Ø£Ø¶ÙÙ‡ Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙƒØªØ·Ø¨ÙŠÙ‚</small>
  </div>
  <button class="i-btn" id="do-install">ØªØ«Ø¨ÙŠØª â¬‡</button>
</div>

<!-- APP -->
<div id="app">

  <!-- TOP BAR -->
  <div id="topbar">
    <div class="brand">CINE<span>FRAME</span></div>
    <div class="top-btns">
      <div class="top-btn" id="btn-grid" title="Grid">âŠ</div>
      <div class="top-btn" id="btn-hist" title="Histogram">ğŸ“Š</div>
      <div class="top-btn" id="btn-flip" title="Flip">ğŸ”„</div>
      <div class="top-btn" id="btn-settings">âš™</div>
    </div>
  </div>

  <!-- MODES -->
  <div id="modes">
    <div class="mode on" data-mode="photo">PHOTO</div>
    <div class="mode" data-mode="video">VIDEO</div>
    <div class="mode" data-mode="cine">CINE 4K</div>
    <div class="mode" data-mode="slow">SLOW-MO</div>
    <div class="mode" data-mode="portrait">PORTRAIT</div>
    <div class="mode" data-mode="pro">PRO</div>
  </div>

  <!-- VIEWFINDER -->
  <div id="vf">
    <video id="video" autoplay muted playsinline></video>

    <div class="cbar" id="cbar-t"></div>
    <div class="cbar" id="cbar-b"></div>

    <div id="grid">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="none">
        <line x1="33.3" y1="0" x2="33.3" y2="100" stroke="rgba(255,255,255,.2)" stroke-width=".3"/>
        <line x1="66.6" y1="0" x2="66.6" y2="100" stroke="rgba(255,255,255,.2)" stroke-width=".3"/>
        <line x1="0" y1="33.3" x2="100" y2="33.3" stroke="rgba(255,255,255,.2)" stroke-width=".3"/>
        <line x1="0" y1="66.6" x2="100" y2="66.6" stroke="rgba(255,255,255,.2)" stroke-width=".3"/>
        <line x1="50" y1="46" x2="50" y2="54" stroke="rgba(255,255,255,.5)" stroke-width=".4"/>
        <line x1="46" y1="50" x2="54" y2="50" stroke="rgba(255,255,255,.5)" stroke-width=".4"/>
        <path d="M4,4 L4,10 M4,4 L10,4" stroke="rgba(255,255,255,.5)" stroke-width=".5" fill="none"/>
        <path d="M96,4 L96,10 M96,4 L90,4" stroke="rgba(255,255,255,.5)" stroke-width=".5" fill="none"/>
        <path d="M4,96 L4,90 M4,96 L10,96" stroke="rgba(255,255,255,.5)" stroke-width=".5" fill="none"/>
        <path d="M96,96 L96,90 M96,96 L90,96" stroke="rgba(255,255,255,.5)" stroke-width=".5" fill="none"/>
      </svg>
    </div>

    <div id="fring"></div>

    <!-- HUD -->
    <div id="hud">
      <div class="hud-r">
        <div>
          <span class="chip" id="hud-mode">PHOTO</span>
          <span class="chip" id="hud-res">4K Â· 16:9</span>
        </div>
        <div style="text-align:right">
          <canvas id="hist-canvas"></canvas>
          <span class="chip go" id="hud-iso" style="margin-top:5px">ISO 100</span>
          <span class="chip" id="hud-ss">1/60s</span>
        </div>
      </div>
      <div class="hud-b">
        <div>
          <span class="chip" id="hud-wb">5600K Â· AWB</span>
          <span class="chip gn" id="hud-zoom">1.0Ã—</span>
        </div>
        <div style="text-align:right">
          <span class="chip" id="hud-fps">30 FPS</span>
          <span class="chip" id="hud-count">0 SHOTS</span>
        </div>
      </div>
    </div>
  </div>

  <!-- BOTTOM PANEL -->
  <div id="bottom">
    <!-- Filters -->
    <div id="filters"></div>

    <!-- Sliders -->
    <div class="sliders">
      <div class="sg">
        <div class="sl-lbl">EV <b id="ev-v">0.0</b></div>
        <input type="range" id="sl-ev" min="-3" max="3" step="0.1" value="0">
      </div>
      <div class="sg">
        <div class="sl-lbl">ISO <b id="iso-v">100</b></div>
        <input type="range" class="iso" id="sl-iso" min="0" max="7" step="1" value="0">
      </div>
      <div class="sg">
        <div class="sl-lbl">WB <b id="wb-v">5600K</b></div>
        <input type="range" class="wb" id="sl-wb" min="2000" max="10000" step="100" value="5600">
      </div>
    </div>

    <!-- Shutter Row -->
    <div class="sh-row">
      <div class="ctrls">
        <div class="cbtn" id="btn-flash">âš¡</div>
        <div class="cbtn" id="btn-timer">â±</div>
      </div>

      <div id="shutter">
        <div id="shutter-inner"></div>
      </div>

      <div class="ctrls">
        <div class="zpill">
          <div class="zo on" data-z="1">1Ã—</div>
          <div class="zo" data-z="2">2Ã—</div>
          <div class="zo" data-z="3">3Ã—</div>
        </div>
        <div class="cbtn" id="btn-gallery">ğŸ–¼</div>
      </div>
    </div>
  </div>

  <!-- SETTINGS PANEL -->
  <div class="panel" id="settings-p">
    <div class="p-title">SETTINGS <div class="close-btn" id="close-settings">âœ•</div></div>

    <div class="sec-lbl">ğŸ¬ Cinema</div>
    <div class="s-row">
      <div><div class="s-lbl">Cinematic Bars</div><div class="s-desc">2.39:1 letterbox</div></div>
      <div class="toggle" data-k="cinebars"></div>
    </div>
    <div class="s-row">
      <div><div class="s-lbl">Focus Peaking</div><div class="s-desc">Edge highlight</div></div>
      <div class="toggle on" data-k="peaking"></div>
    </div>
    <div class="s-row">
      <div><div class="s-lbl">Zebra Stripes</div><div class="s-desc">Overexposure warning</div></div>
      <div class="toggle" data-k="zebra"></div>
    </div>

    <div class="sec-lbl">ğŸ“¹ Video</div>
    <div class="s-row">
      <div><div class="s-lbl">4K Recording</div><div class="s-desc">3840Ã—2160</div></div>
      <div class="toggle on" data-k="4k"></div>
    </div>
    <div class="s-row">
      <div><div class="s-lbl">60 FPS</div></div>
      <div class="toggle" data-k="60fps"></div>
    </div>
    <div class="s-row">
      <div><div class="s-lbl">Log Profile</div><div class="s-desc">Flat color for grading</div></div>
      <div class="toggle" data-k="log"></div>
    </div>

    <div class="sec-lbl">ğŸ“· Photo</div>
    <div class="s-row">
      <div><div class="s-lbl">HDR Mode</div></div>
      <div class="toggle on" data-k="hdr"></div>
    </div>
    <div class="s-row">
      <div><div class="s-lbl">Live Histogram</div></div>
      <div class="toggle on" data-k="histogram"></div>
    </div>
    <div class="s-row">
      <div><div class="s-lbl">Haptic Feedback</div></div>
      <div class="toggle on" data-k="haptic"></div>
    </div>
    <div class="s-row">
      <div><div class="s-lbl">Aspect Ratio</div></div>
      <select class="s-sel" id="asp-sel">
        <option>16:9</option><option>4:3</option><option>1:1</option><option>2.39:1</option>
      </select>
    </div>
  </div>

  <!-- GALLERY PANEL -->
  <div class="panel" id="gallery-p">
    <div class="p-title">GALLERY <div class="close-btn" id="close-gallery">âœ•</div></div>
    <div id="gal-grid">
      <div class="g-empty">
        <div class="ei">ğŸ“·</div>
        Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ø¨Ø¹Ø¯
      </div>
    </div>
  </div>

</div><!-- #app -->

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CINEFRAME PRO v2 â€” Complete Application
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const ISO_STEPS = [100,200,400,800,1600,3200,6400,12800];

const FILTERS = [
  {id:'none',   name:'Normal',  css:'',                                                    grad:['#1a1a1a','#333']},
  {id:'cine',   name:'Cine',    css:'contrast(1.1) saturate(0.82) sepia(0.12)',            grad:['#2a1a0a','#4a3010']},
  {id:'kodak',  name:'Kodak',   css:'saturate(1.25) hue-rotate(-6deg) contrast(1.06)',     grad:['#3a1a0a','#5a2a10']},
  {id:'teal',   name:'Teal-OJ', css:'saturate(1.15) hue-rotate(12deg) contrast(1.08)',    grad:['#0a1a1a','#102a2a']},
  {id:'bw',     name:'B&W',     css:'grayscale(1) contrast(1.1)',                          grad:['#222','#555']},
  {id:'noir',   name:'Noir',    css:'grayscale(1) contrast(1.45) brightness(0.8)',         grad:['#000','#1a1a1a']},
  {id:'fade',   name:'Fade',    css:'contrast(0.82) brightness(1.12) saturate(0.75)',      grad:['#1a1a10','#2a2a1a']},
  {id:'vivid',  name:'Vivid',   css:'saturate(1.55) contrast(1.12)',                       grad:['#1a0a1a','#2a102a']},
  {id:'sunset', name:'Sunset',  css:'saturate(1.35) hue-rotate(-18deg) contrast(1.06)',   grad:['#2a0a00','#4a1a00']},
  {id:'cool',   name:'Cool',    css:'hue-rotate(18deg) saturate(0.9) brightness(1.06)',    grad:['#0a0a1a','#10102a']},
  {id:'warm',   name:'Warm',    css:'hue-rotate(-12deg) saturate(1.12)',                  grad:['#1a1000','#2a2000']},
  {id:'slog',   name:'S-LOG',   css:'contrast(0.68) brightness(1.25) saturate(0.55)',     grad:['#101010','#1a1a1a']},
];

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const S = {
  mode:'photo', recording:false,
  facing:'environment', zoom:1,
  iso:100, ev:0, wb:5600,
  filter:'none',
  flash:'off', timer:0,
  photos:[], shots:0,
  stream:null, recorder:null, chunks:[],
  recStart:0, recTicker:null,
  settings:{
    cinebars:false, peaking:true, zebra:false,
    '4k':true, '60fps':false, log:false,
    hdr:true, histogram:true, haptic:true,
  },
  deferredInstall:null,
};

// â”€â”€ DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $ = id => document.getElementById(id);
const video     = $('video');
const histCvs   = $('hist-canvas');
const histCtx   = histCvs.getContext('2d');
const fring     = $('fring');
const cbarT     = $('cbar-t');
const cbarB     = $('cbar-b');
const shutter   = $('shutter');
const flashOvl  = $('flash-overlay');
const toastEl   = $('toast');
const countEl   = $('countdown');
const countNum  = $('countdown-num');

histCvs.width = 96; histCvs.height = 38;

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg, ms=2200){
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  clearTimeout(toastEl._t);
  toastEl._t = setTimeout(()=>toastEl.classList.remove('show'), ms);
}
function haptic(h='light'){
  if(!S.settings.haptic) return;
  try{ navigator.vibrate && navigator.vibrate(h==='heavy'?30:10); }catch(e){}
}
function fmtTime(ms){
  const s=Math.floor(ms/1000), m=Math.floor(s/60);
  return `${String(m).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
}
function getWBName(k){
  return k<3200?'TUNGSTEN':k<4200?'FLUOR':k<5500?'DAYLIGHT':k<6500?'CLOUDY':'SHADE';
}

// â”€â”€ CAMERA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startCamera(){
  try {
    if(S.stream) S.stream.getTracks().forEach(t=>t.stop());

    // Request highest resolution available
    const constraints = {
      video:{
        facingMode: S.facing,
        width:  {ideal:3840},
        height: {ideal:2160},
        frameRate:{ideal:30,max:60},
      },
      audio: true
    };

    let stream;
    try {
      stream = await navigator.mediaDevices.getUserMedia(constraints);
    } catch {
      // Fallback to 1080p
      constraints.video.width  = {ideal:1920};
      constraints.video.height = {ideal:1080};
      try {
        stream = await navigator.mediaDevices.getUserMedia(constraints);
      } catch {
        // Fallback to any camera
        stream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
      }
    }

    S.stream = stream;
    video.srcObject = stream;

    video.onloadedmetadata = () => {
      video.play().catch(console.warn);
      const t = stream.getVideoTracks()[0];
      const st = t.getSettings();
      $('hud-res').textContent = `${st.width||'?'}Ã—${st.height||'?'}`;
      toast(`ğŸ“· Camera ready Â· ${st.width}Ã—${st.height}`);
    };

    $('error-screen').classList.remove('show');
    applyVideoFilter();
    startHistLoop();

  } catch(err){
    console.error('Camera error:', err);
    $('error-screen').classList.add('show');
  }
}

window.retryCamera = () => startCamera();

// â”€â”€ ZOOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setZoom(z){
  S.zoom = z;
  $('hud-zoom').textContent = z.toFixed(1)+'Ã—';

  if(S.stream){
    const t = S.stream.getVideoTracks()[0];
    if(t){
      const caps = t.getCapabilities ? t.getCapabilities() : {};
      if(caps.zoom){
        t.applyConstraints({advanced:[{zoom:Math.min(caps.zoom.max,Math.max(caps.zoom.min,z))}]}).catch(()=>{
          video.style.transform = `scale(${z})`;
          video.style.transformOrigin = 'center';
        });
      } else {
        video.style.transform = z===1 ? '' : `scale(${z})`;
        video.style.transformOrigin = 'center';
      }
    }
  }

  document.querySelectorAll('.zo').forEach(b=>b.classList.toggle('on', parseFloat(b.dataset.z)===z));
}

// â”€â”€ FOCUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tapFocus(x,y){
  fring.style.left = x+'px';
  fring.style.top  = y+'px';
  fring.className = 'show';

  if(S.stream){
    const t = S.stream.getVideoTracks()[0];
    if(t){
      const r = video.getBoundingClientRect();
      t.applyConstraints({advanced:[{
        focusMode:'manual',
        pointsOfInterest:[{x:(x-r.left)/r.width, y:(y-r.top)/r.height}]
      }]}).catch(()=>{});
    }
  }

  clearTimeout(fring._t);
  fring._t = setTimeout(()=>{
    fring.className='lock';
    setTimeout(()=>fring.className='',1800);
  },550);
}

// Tap focus + double-tap zoom
let lastTap=0;
$('vf').addEventListener('click', e=>{
  const now=Date.now();
  if(now-lastTap<280){
    const nz = S.zoom===1?2:1;
    setZoom(nz);
    toast(nz+'Ã— Zoom');
  } else {
    tapFocus(e.clientX, e.clientY);
    haptic();
  }
  lastTap=now;
});

// Pinch zoom
let pinchD=0;
$('vf').addEventListener('touchstart', e=>{
  if(e.touches.length===2)
    pinchD=Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
},{passive:true});
$('vf').addEventListener('touchmove', e=>{
  if(e.touches.length===2){
    e.preventDefault();
    const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
    const nz=Math.min(10,Math.max(1, S.zoom+(d-pinchD)*0.015));
    pinchD=d;
    setZoom(parseFloat(nz.toFixed(2)));
  }
},{passive:false});

// Swipe up â†’ gallery
let swipeY=0;
$('vf').addEventListener('touchstart', e=>swipeY=e.touches[0].clientY,{passive:true});
$('vf').addEventListener('touchend', e=>{
  if(e.changedTouches[0].clientY - swipeY < -70) openGallery();
},{passive:true});

// â”€â”€ VIDEO FILTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyVideoFilter(){
  const f = FILTERS.find(f=>f.id===S.filter)||FILTERS[0];
  const bright = 1 + (S.ev*0.18);
  const hueShift = ((S.wb-5600)/100)*-0.4;
  video.style.filter = `brightness(${bright.toFixed(2)}) hue-rotate(${hueShift.toFixed(1)}deg) ${f.css}`;
}

// â”€â”€ SLIDERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('sl-ev').addEventListener('input', function(){
  S.ev=parseFloat(this.value);
  $('ev-v').textContent=(S.ev>=0?'+':'')+S.ev.toFixed(1);
  applyVideoFilter();
});
$('sl-iso').addEventListener('input', function(){
  S.iso=ISO_STEPS[+this.value];
  $('iso-v').textContent=S.iso;
  $('hud-iso').textContent='ISO '+S.iso;
  updateSS();
  applyVideoFilter();
});
$('sl-wb').addEventListener('input', function(){
  S.wb=+this.value;
  $('wb-v').textContent=S.wb+'K';
  $('hud-wb').textContent=S.wb+'K Â· '+getWBName(S.wb);
  applyVideoFilter();
});

function updateSS(){
  const fps=S.settings['60fps']?60:30;
  const ss=Math.round(1/(fps/180*(S.iso/100)));
  $('hud-ss').textContent=`1/${Math.max(4,Math.min(8000,ss))}s`;
}

// â”€â”€ HISTOGRAM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let histFrame;
function startHistLoop(){
  cancelAnimationFrame(histFrame);
  function loop(){
    drawHist();
    histFrame=requestAnimationFrame(loop);
  }
  loop();
}

// Temp canvas for sampling
const tmpCvs=document.createElement('canvas');
tmpCvs.width=80; tmpCvs.height=60;
const tmpCtx=tmpCvs.getContext('2d');

function drawHist(){
  if(!S.settings.histogram){histCtx.clearRect(0,0,96,38);return;}
  const w=96,h=38;
  let R,G,B;

  if(video.readyState>=2 && video.videoWidth>0){
    try{
      tmpCtx.drawImage(video,0,0,80,60);
      const px=tmpCtx.getImageData(0,0,80,60).data;
      R=new Uint32Array(256); G=new Uint32Array(256); B=new Uint32Array(256);
      for(let i=0;i<px.length;i+=4){R[px[i]]++;G[px[i+1]]++;B[px[i+2]]++;}
    }catch(e){ R=G=B=null; }
  }

  if(!R){
    // Simulated
    const c=128+S.ev*22, sp=40+S.iso/200;
    R=new Uint32Array(256); G=new Uint32Array(256); B=new Uint32Array(256);
    for(let i=0;i<256;i++){
      R[i]=Math.max(0,Math.round(280*Math.exp(-((i-c-5)**2)/(2*sp**2))+Math.random()*15));
      G[i]=Math.max(0,Math.round(300*Math.exp(-((i-c)**2)/(2*sp**2))+Math.random()*15));
      B[i]=Math.max(0,Math.round(260*Math.exp(-((i-c+5)**2)/(2*sp**2))+Math.random()*15));
    }
  }

  histCtx.clearRect(0,0,w,h);
  histCtx.fillStyle='rgba(0,0,0,.65)';
  histCtx.fillRect(0,0,w,h);

  const mx=Math.max(...R,...G,...B)||1;
  drawCh(R,mx,w,h,'rgba(255,70,70,.65)');
  drawCh(G,mx,w,h,'rgba(70,255,70,.55)');
  drawCh(B,mx,w,h,'rgba(70,130,255,.6)');

  // Clip lines
  histCtx.fillStyle='rgba(255,255,255,.2)';
  histCtx.fillRect(0,0,1,h);
  histCtx.fillRect(w-1,0,1,h);
}
function drawCh(data,max,w,h,color){
  histCtx.beginPath();
  histCtx.moveTo(0,h);
  for(let i=0;i<256;i++){
    histCtx.lineTo((i/255)*w, h-(data[i]/max)*(h-2));
  }
  histCtx.lineTo(w,h);
  histCtx.closePath();
  histCtx.fillStyle=color;
  histCtx.fill();
}

// â”€â”€ FILTERS STRIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildFilters(){
  const strip=$('filters');
  strip.innerHTML='';
  FILTERS.forEach(f=>{
    const el=document.createElement('div');
    el.className='fi'+(S.filter===f.id?' on':'');
    const cvs=document.createElement('canvas');
    cvs.width=48; cvs.height=48;
    drawFilterThumb(cvs.getContext('2d'), f);
    el.innerHTML=`<div class="fi-thumb"></div><div class="fi-name">${f.name}</div>`;
    el.querySelector('.fi-thumb').appendChild(cvs);
    el.onclick=()=>{
      S.filter=f.id;
      document.querySelectorAll('.fi').forEach(i=>i.classList.remove('on'));
      el.classList.add('on');
      applyVideoFilter();
      toast('Filter: '+f.name);
      haptic();
    };
    strip.appendChild(el);
  });
}

function drawFilterThumb(ctx, f){
  const w=48,h=48;
  const g=ctx.createLinearGradient(0,0,w,h);
  g.addColorStop(0,f.grad[0]);
  g.addColorStop(1,f.grad[1]);
  ctx.fillStyle=g;
  ctx.fillRect(0,0,w,h);
  ctx.fillStyle='rgba(255,220,100,.3)';
  ctx.fillRect(0,0,w/2,h/2);
  ctx.fillStyle='rgba(80,160,220,.3)';
  ctx.fillRect(w/2,h/2,w/2,h/2);
  if(f.id==='bw'||f.id==='noir'){
    const d=ctx.getImageData(0,0,w,h);
    for(let i=0;i<d.data.length;i+=4){
      const v=d.data[i]*.299+d.data[i+1]*.587+d.data[i+2]*.114;
      d.data[i]=d.data[i+1]=d.data[i+2]=f.id==='noir'?v*.75:v;
    }
    ctx.putImageData(d,0,0);
  }
  ctx.fillStyle='rgba(255,255,255,.35)';
  ctx.font='5px monospace';
  ctx.fillText(f.name.slice(0,6),3,h-4);
}

// â”€â”€ CAPTURE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doShutter(){
  if(['video','cine','slow'].includes(S.mode)){
    toggleRec();
    return;
  }
  if(S.timer>0){
    runTimer();
    return;
  }
  snap();
}

function snap(){
  haptic('heavy');
  flashOvl.classList.remove('flash');
  void flashOvl.offsetWidth;
  flashOvl.classList.add('flash');

  // Capture from live video with filter applied
  const cvs=document.createElement('canvas');
  const vw=video.videoWidth||1920;
  const vh=video.videoHeight||1080;
  cvs.width=vw; cvs.height=vh;
  const ctx=cvs.getContext('2d');

  const f=FILTERS.find(f=>f.id===S.filter)||FILTERS[0];
  if(f.css) ctx.filter=f.css;
  const b=1+(S.ev*0.18);
  ctx.filter=(ctx.filter?ctx.filter+' ':'')+`brightness(${b.toFixed(2)})`;
  ctx.drawImage(video,0,0);

  const url=cvs.toDataURL('image/jpeg',0.93);
  S.photos.push({url, filter:f.name, iso:S.iso, ev:S.ev, ts:new Date().toLocaleTimeString()});
  S.shots++;
  $('hud-count').textContent=S.shots+' SHOTS';
  updateGallery();
  toast(`ğŸ“¸ ${f.name} Â· ISO${S.iso} Â· ${vw}Ã—${vh}`);
}

function runTimer(){
  let n=S.timer;
  countNum.textContent=n;
  countEl.classList.add('show');
  haptic();
  const iv=setInterval(()=>{
    n--;
    countNum.textContent=n;
    haptic();
    if(n<=0){
      clearInterval(iv);
      countEl.classList.remove('show');
      snap();
    }
  },1000);
}

// â”€â”€ RECORDING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleRec(){
  S.recording ? stopRec() : startRec();
}

function startRec(){
  if(!S.stream){toast('âŒ No camera');return;}
  S.chunks=[];
  let opts={mimeType:'video/webm;codecs=vp9,opus'};
  try{ S.recorder=new MediaRecorder(S.stream,opts); }
  catch{ 
    try{ S.recorder=new MediaRecorder(S.stream,{mimeType:'video/webm'}); }
    catch{ 
      try{ S.recorder=new MediaRecorder(S.stream); }
      catch{ toast('âŒ Recording not supported'); return; }
    }
  }
  S.recorder.ondataavailable=e=>{ if(e.data.size>0) S.chunks.push(e.data); };
  S.recorder.onstop=()=>{
    const blob=new Blob(S.chunks,{type:'video/webm'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=`cineframe_${Date.now()}.webm`;
    a.click();
    toast('ğŸ’¾ Video saved!');
  };
  S.recorder.start(100);
  S.recording=true;
  S.recStart=Date.now();
  shutter.classList.add('rec');
  S.recTicker=setInterval(()=>{
    $('hud-fps').innerHTML=`<span style="color:var(--red)">âº ${fmtTime(Date.now()-S.recStart)}</span>`;
  },1000);
  haptic('heavy');
  toast('ğŸ¬ Recordingâ€¦');
}

function stopRec(){
  if(S.recorder && S.recording){
    S.recorder.stop();
    S.recording=false;
    shutter.classList.remove('rec');
    clearInterval(S.recTicker);
    $('hud-fps').textContent='30 FPS';
    haptic('heavy');
  }
}

// â”€â”€ GALLERY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateGallery(){
  const g=$('gal-grid');
  if(!S.photos.length){
    g.innerHTML='<div class="g-empty"><div class="ei">ğŸ“·</div>Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ø¨Ø¹Ø¯</div>';
    return;
  }
  g.innerHTML='';
  [...S.photos].reverse().forEach((p,i)=>{
    const el=document.createElement('div');
    el.className='g-item';
    el.innerHTML=`<img src="${p.url}" loading="lazy"><div class="g-meta">${p.filter} Â· ISO${p.iso}</div>`;
    el.onclick=()=>{
      const a=document.createElement('a');
      a.href=p.url;
      a.download=`cineframe_${p.filter.toLowerCase()}_${Date.now()}.jpg`;
      a.click();
      toast('ğŸ’¾ Photo saved!');
    };
    g.appendChild(el);
  });
}

function openGallery(){
  $('gallery-p').classList.add('open');
  haptic();
}

// â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
shutter.addEventListener('click',()=>doShutter());

$('btn-grid').addEventListener('click',()=>{
  const g=$('grid');
  g.classList.toggle('on');
  $('btn-grid').classList.toggle('on', g.classList.contains('on'));
  haptic();
});

$('btn-hist').addEventListener('click',()=>{
  S.settings.histogram=!S.settings.histogram;
  $('btn-hist').classList.toggle('on', S.settings.histogram);
  haptic();
});

$('btn-flip').addEventListener('click',()=>{
  S.facing=S.facing==='environment'?'user':'environment';
  startCamera();
  haptic();
  toast(S.facing==='user'?'ğŸ¤³ Front camera':'ğŸ“· Rear camera');
});

$('btn-settings').addEventListener('click',()=>{
  $('settings-p').classList.add('open');haptic();
});
$('close-settings').addEventListener('click',()=>{
  $('settings-p').classList.remove('open');haptic();
});
$('btn-gallery').addEventListener('click',()=>{ openGallery(); });
$('close-gallery').addEventListener('click',()=>{
  $('gallery-p').classList.remove('open');haptic();
});

// Flash
const FLASH_STATES=['off','on','auto'];
const FLASH_ICONS={off:'âš¡',on:'ğŸ’¡',auto:'âœ¨'};
$('btn-flash').addEventListener('click',()=>{
  const i=FLASH_STATES.indexOf(S.flash);
  S.flash=FLASH_STATES[(i+1)%3];
  $('btn-flash').textContent=FLASH_ICONS[S.flash];
  $('btn-flash').classList.toggle('on',S.flash!=='off');
  if(S.stream){
    const t=S.stream.getVideoTracks()[0];
    if(t) t.applyConstraints({advanced:[{torch:S.flash==='on'}]}).catch(()=>{});
  }
  toast('Flash: '+S.flash.toUpperCase());
  haptic();
});

// Timer
const TIMER_OPTS=[0,3,10];
$('btn-timer').addEventListener('click',()=>{
  const i=TIMER_OPTS.indexOf(S.timer);
  S.timer=TIMER_OPTS[(i+1)%3];
  $('btn-timer').textContent=S.timer===0?'â±':'â±'+S.timer;
  $('btn-timer').classList.toggle('on',S.timer>0);
  toast(S.timer===0?'Timer off':'Timer: '+S.timer+'s');
  haptic();
});

// Zoom buttons
document.querySelectorAll('.zo').forEach(b=>{
  b.addEventListener('click',()=>{
    setZoom(parseFloat(b.dataset.z));
    toast(b.dataset.z+'Ã— Zoom');
    haptic();
  });
});

// Mode strip
document.querySelectorAll('.mode').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.mode').forEach(b=>b.classList.remove('on'));
    btn.classList.add('on');
    S.mode=btn.dataset.mode;
    $('hud-mode').textContent=btn.textContent;
    const isVid=['video','cine','slow'].includes(S.mode);
    shutter.style.background=isVid?'var(--red)':'var(--white)';
    if(S.mode==='cine'){
      cbarT.classList.add('on'); cbarB.classList.add('on');
      $('hud-fps').textContent='24 FPS';
    } else {
      cbarT.classList.remove('on'); cbarB.classList.remove('on');
      $('hud-fps').textContent=S.mode==='slow'?'240 FPS':'30 FPS';
    }
    if(S.recording) stopRec();
    toast('Mode: '+btn.textContent);
    haptic();
  });
});

// Settings toggles
document.querySelectorAll('.toggle[data-k]').forEach(t=>{
  const k=t.dataset.k;
  if(S.settings[k]) t.classList.add('on');
  t.addEventListener('click',()=>{
    S.settings[k]=!S.settings[k];
    t.classList.toggle('on',S.settings[k]);
    haptic();
    if(k==='cinebars'){cbarT.classList.toggle('on',S.settings[k]);cbarB.classList.toggle('on',S.settings[k]);}
  });
});

// Aspect ratio
$('asp-sel').addEventListener('change',function(){
  $('hud-res').textContent='4K Â· '+this.value;
  toast('Aspect: '+this.value);
});

// Keyboard shortcuts
document.addEventListener('keydown',e=>{
  if(e.target.tagName==='SELECT'||e.target.tagName==='INPUT') return;
  if(e.code==='Space'){e.preventDefault();doShutter();}
  if(e.code==='KeyG') $('btn-grid').click();
  if(e.code==='KeyF') $('btn-flip').click();
  if(e.key==='+') setZoom(Math.min(10,S.zoom+.5));
  if(e.key==='-') setZoom(Math.max(1,S.zoom-.5));
});

// â”€â”€ PWA INSTALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('beforeinstallprompt', e=>{
  e.preventDefault();
  S.deferredInstall=e;
  $('install-btn').classList.add('show');
});
$('do-install').addEventListener('click',()=>{
  if(!S.deferredInstall) return;
  S.deferredInstall.prompt();
  S.deferredInstall.userChoice.then(()=>{
    $('install-btn').classList.remove('show');
    S.deferredInstall=null;
  });
});
window.addEventListener('appinstalled',()=>{
  $('install-btn').classList.remove('show');
  toast('âœ… App installed!');
});

// â”€â”€ SERVICE WORKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./sw.js').then(()=>{
    console.log('SW registered');
  }).catch(console.warn);
}

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async function boot(){
  buildFilters();
  updateSS();

  // Hide splash after camera starts
  setTimeout(async ()=>{
    await startCamera();
    $('app').classList.add('ready');
    setTimeout(()=>{ $('splash').style.display='none'; }, 600);
  }, 2200);

  // Start histogram sim even before camera
  setTimeout(()=>{
    if(!histFrame) startHistLoop();
  }, 500);
})();
</script>
</body>
</html>
